1,1,FF,ff_addCustomCSSFile,Add custom CSS File,"Adds a custom css file to the form. To choose a css file, execute this piece and call the function ff_addCustomCSSFile('path/to/css/file') with the RELATIVE (not full!) path to your joomla installation.
Do not forget to call $this->execPieceByName('ff_InitLib') before!

Example:

global $mainframe;

$this->execPieceByName('ff_InitLib');
$this->execPieceByName('ff_addCustomCSSFile');

ff_addCustomCSSFile('templates/' . $mainframe->getTemplate() . '/css/template.css');",Before Form,"function ff_addCustomCSSFile($path){
	if(file_exists(JPATH_SITE . '/' . $path)){
		JFactory::getDocument()->addStyleSheet(JURI::root() . $path);
	}
}"
2,1,FF,ff_Constants,Constansts definitions,Library constants definitions,Before Form,"define('FF_DIE',       '_ff_die_on_errors_');
define('FF_DONTDIE',   '_ff_stay_alive_');
define('FF_IGNOREDIE', '_ff_ignore_if_dying_');

define('FF_ARRAY',     '_ff_return_as_array_');
define('FF_LIST',      '_ff_return_as_list_');
define('FF_SLIST',     '_ff_return_as_slist_');
define('FF_DLIST',     '_ff_return_as_dlist_');

define('FF_NOTRIM',    1);
define('FF_ALLOWHTML', 2);
define('FF_ALLOWRAW',  4);"
3,1,FF,ff_die,Terminate form gracefully,"Gracefully terminates the form and shows a message plus opionally a 
CONTINUE button for further redirection.

Call:

    ff_die($message=null, $action='stop', $target='', $params='', $label='Continue');
    return;

    $message = A message to display. If no message is provided, it will
               display:

                    Fatal error in $formname, processing stopped.

    $action  = 'stop' : Dont show a CONTINUE button (default)
               'self' : Redirect to the same form
               'form' : Redirect to another form 
               'page' : Redirect to another page of this site
               'home' : Redirect to homepage of the site
               'url'  : Redirect to a url

    $target  = Target name/url for 'form', 'page' and 'url'

    $params  = Additional parameters for 'self' and 'form'

    $label   = Text for the continue button

Examples:

    // Display standard message without continue button
    ff_die(); 

    // Display message without continue button
    ff_die('Sorry, cannot continue for some reason.');

    // Display standard message and return to same form with a parameter
    ff_die(null, 'self', '&ff_param_foo=bar');

    // Redirect to another form
    ff_die('Guess you are hungry now...', 'form', 'SamplePizzaShop', null, 'Order');

    // Redirect to another site page
    ff_die(
        'Something strange has happened!', 
        'page', 
        'index.php?option=com_content&task=section&id=1&Itemid=2'
    );",Untyped,"function ff_die($message='', $action='stop', $target='', $params='', $label='Continue')
{
    global $ff_processor;
    if ($ff_processor->dying) return;

    ob_end_clean();
    $form =& $ff_processor->formrow;
    if (!$message) 
        $message = 
            ""<strong>Fatal error in $form->name, form processing halted.</strong>"";
    switch ($action) {
        case 'self': $url = ff_makeSelfUrl($params); break;
        case 'form': $url = ff_makeFormUrl($target, $params); break;
        case 'page': $url = ff_makePageUrl($target); break;
        case 'home': $url = ""{mossite}""; break;
        case 'url' : $url = $target; break;
        default    : $url = '';
    } // switch
    if ($form->class1 != '') echo '<div class=""'.$form->class1.'"">'.nl();
    echo($message.'<br/><br/><br/>'.nl());
    if ($url) {
        if (!$ff_processor->inline) echo '<form action=""#redirect"">'.nl();
        if ($ff_processor->inframe) $t = 'parent'; else $t = 'document';
        echo '<input type=""button"" class=""button"" value=""'.$label.'""'.
             ' onClick=""'.$t.'.location.href=\''.htmlentities($url,ENT_QUOTES).'\';""'.
             '/>'.nl();
        if (!$ff_processor->inline) echo '</form>'.nl();
    } // if
    if ($form->class1 != '') echo '</div>'.nl();
    unset($form);
    ob_start();
    $ff_processor->suicide();
} // ff_die"
4,1,FF,ff_DisableFormTrace,Disable tracing at view time,Disables tracing for use as before form piece,Before Form,//+trace dis
5,1,FF,ff_DisableSubmitTrace,Disable tracing at submit time,Disables tracing for use as begin submit piece,Begin Submit,//+trace dis
6,1,FF,ff_dying,Query live status,Query if form is dying,Untyped,"//+trace max none
function ff_dying()
{
    global $ff_processor; 
    return $ff_processor->dying;
} // ff_dying"
7,1,FF,ff_expString,String export,Export string function: escapes special characters in c-codes,Untyped,"function ff_expString($text)
{
    return expstring($text);
} // ff_expString"
8,1,FF,ff_getPageByNameX,Get page # by element name,"Gets the page number by the name of an element. 
Typically used to redirect to a certain page in a before form piece 
as 

    $this->page = ff_getPageByName('elementname');",Untyped,"function ff_getPageByName($name)
{
    global $ff_processor;
    foreach($ff_processor->rows as $row)
        if ($row->name==$name)
            return $row->page;
    return null;
} // ff_getPageByName"
9,1,FF,ff_getParam,Get GET/POST parameter,"Direct replacement for mosGetParam. ff_getParam will attempt to filter 
out parameters that are targeted to another form on the same page.",Untyped,"function ff_getParam($name, $default=null, $mask=0)
{
    global $ff_request;
    if (substr($name,0,9)=='ff_param_') {
        if (!isset($ff_request[$name])) return $default;
        $val = $ff_request[$name];
    } else {
        if (!isset($_REQUEST[$name])) return $default;
        $val = $_REQUEST[$name];
    } // if
    $dotrim = ($mask & FF_NOTRIM)==0;
    $dostrp = ($mask & FF_ALLOWHTML)==0;
    $addsla = ($mask & FF_ALLOWRAW)==0 && !get_magic_quotes_gpc();
    $remsla = ($mask & FF_ALLOWRAW)!=0 && get_magic_quotes_gpc();
    if (is_array($val)) {
        $cnt = count($val);
        for ($v = 0; $v < $cnt; $v++)
            if (is_string($val[$v])) {
                if ($dotrim) $val[$v] = trim($val[$v]);
                if ($dostrp) $val[$v] = strip_tags($val[$v]);
                if ($addsla) $val[$v] = addslashes($val[$v]);
                if ($remsla) $val[$v] = stripslashes($val[$v]);
            } // if
    } else {
        if (is_string($val)) {
            if ($dotrim) $val = trim($val);
            if ($dostrp) $val = strip_tags($val);
            if ($addsla) $val = addslashes($val);
            if ($remsla) $val = stripslashes($val);
        } // if
    } // if
    return $val;
} // ff_getParam"
10,1,FF,ff_getSubmit,Get submited data,"Returns submitdata either as scalar, array or list. In case of list the values
are returned as a string with the values concatenated by comma.

Examples:

// Get as scalar: Optionally pass a default value as second parameter.
// If no default is provided, it will return NULL if no value was submitted

    $myval = ff_getSubmit('myvar');        // return NULL if not submitted

    $myval = ff_getSubmit('myvar',1);      // return 1 if not submitted

    $myval = ff_getSubmit('myvar','foo');  // return 'foo' if not submitted

    ff_query(
        ""insert into #__mytable(id, name) "".
        ""values ('"".
            ff_getSubmit('id')."", "".
            ff_getSubmit('name','unknown').
        ""')""
    );

// Get as array: Pass FF_ARRAY as second Parameter

    $myarr = $ff_getSubmit('myarr', FF_ARRAY);

    foreach ($myarr as $myval) ...

// Get as list: Pass either FF_LIST, FF_SLIST or FF_DLIST as 2nd parameter.

    // FF_LIST will return numeric data unquoted and strings in single quotes:
    //    1,2,'a',4

    // FF_SLIST will return all data single quoted:
    //    '1','2','a','4'

    // FF_DLIST will return all data double quoted:
    //    ""1"",""2"",""a"",""4""

    ff_query(
        ""delete from #__mytable "".
        ""where id in ("".ff_getSubmit('itemlist',FF_LIST)."")""
    );",Untyped,"function ff_getSubmit($name, $default=null)
{
    global $ff_processor;

    switch ((string)$default) {
        case FF_ARRAY: $value = array(); break;
        case FF_LIST : 
        case FF_SLIST:
        case FF_DLIST: $value = ''; break;
        default      : $value = $default;
    } // switch
    foreach ($ff_processor->submitdata as $data)
        if ($data[_FF_DATA_NAME]==$name) {
            $q = '';
            switch ((string)$default) {
                case FF_ARRAY:
                    $value[] = $data[_FF_DATA_VALUE];
                    break;
                case FF_SLIST:
                    $q = ""'"";
                case FF_DLIST:
                    if ($q=='') $q = '""';
                case FF_LIST:
                    if ($q=='' && !is_numeric($data[_FF_DATA_VALUE])) $q = ""'"";
                    if ($value!='') $value.=',';
                    $value .= $q.$data[_FF_DATA_VALUE].$q;
                    break;
                default:
                    return $data[_FF_DATA_VALUE];
            } // switch
         } // if
    return $value;
} // ff_getSubmit"
11,1,FF,ff_impString,String import,Import string function: unescapes c-coded characters of a string,Untyped,"function ff_impString($text)
{
    return impstring($text);
} // ff_impString"
12,1,FF,ff_InitLib,Init Library,"A collection of useful functions for use in form pieces. 

Include by: 

    $this->execPieceByName('ff_InitLib');",Before Form,"//+trace high none
if (!defined('FF_DIE'))                    $this->execPieceByName('ff_Constants');
if (!function_exists('ff_expstring'))      $this->execPieceByName('ff_expstring');
if (!function_exists('ff_makePageUrl'))    $this->execPieceByName('ff_makePageUrl');
if (!function_exists('ff_makeFormUrl'))    $this->execPieceByName('ff_makeFormUrl');
if (!function_exists('ff_makeSelfUrl'))    $this->execPieceByName('ff_makeSelfUrl');
if (!function_exists('ff_die'))            $this->execPieceByName('ff_die');
if (!function_exists('ff_dying'))          $this->execPieceByName('ff_dying');
if (!function_exists('ff_redirect'))       $this->execPieceByName('ff_redirect');
if (!function_exists('ff_redirectParent')) $this->execPieceByName('ff_redirectParentX');
if (!function_exists('ff_redirectPage'))   $this->execPieceByName('ff_redirectPage');
if (!function_exists('ff_redirectForm'))   $this->execPieceByName('ff_redirectForm');
if (!function_exists('ff_redirectSelf'))   $this->execPieceByName('ff_redirectSelf');
if (!function_exists('ff_setChecked'))     $this->execPieceByName('ff_setCheckedX');
if (!function_exists('ff_setSelected'))    $this->execPieceByName('ff_setSelectedX');
if (!function_exists('ff_setValue'))       $this->execPieceByName('ff_setValueX');
if (!function_exists('ff_getPageByName'))  $this->execPieceByName('ff_getPageByNameX');
if (!function_exists('ff_getParam'))       $this->execPieceByName('ff_getParam');
if (!function_exists('ff_getSubmit'))      $this->execPieceByName('ff_getSubmit');
if (!function_exists('ff_impString'))      $this->execPieceByName('ff_impString');
if (!function_exists('ff_expString'))      $this->execPieceByName('ff_expString');
if (!function_exists('ff_securityImage'))  $this->execPieceByName('ff_securityImage');
if (!function_exists('ff_select'))         $this->execPieceByName('ff_select');
if (!function_exists('ff_selectValue'))    $this->execPieceByName('ff_selectValue');
if (!function_exists('ff_query'))          $this->execPieceByName('ff_query');
if (!function_exists('ff_markdown'))       $this->execPieceByName('ff_markdown');"
13,1,FF,ff_makeFormUrl,Make URL to other form,"Redirects to another facile form. 

Call: 

    $url = ff_makeFormUrl($name, $params = '');

Example:

    $url = ff_makeFormUrl(
       'OtherForm', 
       '&ff_param_email='.urlencode($email)
    );",Untyped,"function ff_makeFormUrl($name, $params='')
{
    global $ff_processor, $ff_otherparams;
    $url = '';
    switch ($ff_processor->runmode) {
        case 2: // preview
        case 1: // backend
            $url .= 'administrator/index2.php?option=com_breezingforms&act=run'.
                    '&ff_name='.urlencode($name);
            if ($ff_processor->inframe) $url .= '&ff_frame=1';
            if ($ff_processor->border) $url .= '&ff_border=1';
            break;
        default: // frontend
            $url .= 'index.php?ff_name='.urlencode($name);
            if ($ff_otherparams['option'] == 'com_breezingforms') {
                reset($ff_otherparams);
                while (list($prop, $val) = each($ff_otherparams))
                    $url .= '&'.urlencode($prop).'='.urlencode($val);
            } else
                $url .= '&option=com_breezingforms';
            if ($ff_processor->target > 1) $url .= '&ff_target='.$ff_processor->target;
            if ($ff_processor->inframe) $url .= '&ff_frame=1';
            if ($ff_processor->border) $url .= '&ff_border=1';
            if ($ff_processor->align !=1) $url .= '&ff_align='.$ff_processor->align;
            if ($ff_processor->top>0) $url .= '&ff_top='.$ff_processor->top;
    } // switch
    return ff_makePageUrl($url. $params);
} // ff_makeFormUrl"
14,1,FF,ff_makePageUrl,Make URL to other page,"Builds an URL to another mambo page

Call: 

    $url = ff_makePageUrl($params = '');

Example:

    $url = ff_makePageUrl(
        'index.php?option=com_content&task=blogsection&id=0&Itemid=39'
    );",Untyped,"function ff_makePageUrl($params='')
{
    $url = '{mossite}';
    if ($params != '') {
        $len = strlen($url);
        if ($len > 0 && $url{$len-1} != '/') $url .= '/';
        $url .= $params;
    } // if
    return $url;
} // ff_makePageUrl"
15,1,FF,ff_makeSelfUrl,Make URL to same form,"Make an URL to the same form. 

Call: 

    $url = ff_makeSelfUrl($params = '');

Example:

    $url = ff_makeSelfUrl('&ff_param_email='.urlencode($email));",Untyped,"function ff_makeSelfUrl($params='')
{
    global $ff_processor;
    return ff_makeFormUrl($ff_processor->formrow->name, $params);
} // ff_makeSelfUrl"
16,1,FF,ff_query,Non-select queries against db,"Execute a simple db query.

Include by one of:

    $this->execPieceByName('ff_InitUtilities');
    $this->execPieceByName('ff_SubmitUtilities');
    if (!function_exists('ff_query')) $this->execPieceByName('ff_query');

Call syntax:

    [$newid = ] ff_query($sql [, $insert = 0]);

    $sql:    Sql statement to call
    $insert: 1 = return key of auto column when inserting rows
    $newid:  The key of the new row.",Untyped,"function ff_query($sql, $insert=false, $error=FF_DIE)
{
    global $ff_processor;
    $database = JFactory::getDBO();
    if ($ff_processor->dying && $error!=FF_IGNOREDIE) return -1;
    $database->setQuery($sql);
    $database->query();
    if ($database->getErrorNum()) {
        $dienow = $error==FF_DIE;
        $error = $database->stderr();
        if ($dienow) ff_die($error);
    } else {
        $error = null;
        if ($insert) return $database->insertid();
    } // if
    return 0;
} // ff_query"
17,1,FF,ff_redirect,Basic redirection,"Basic redirection routine supporting multiple targets and methods.

Call:
 
ff_redirect($url [, $target='self' , $method='post'])

    $url    = The url to redirect to including the parameters appended.

    $target = 'top', 'parent', 'self' or 'blank'

              'top'    = redirect to the top browser window
              'parent' = redirect to the parent frame
              'self'   = redirect in the same frame (the default)
              'blank'  = redirect to a new browser window 
                         (blank works with post method only)

    $method = 'post' or 'get'. The default is 'post'.

    Example:

       ff_redirect(
          'http://mysite.net/index.php?option=xxx&Itemid=33',
          'top'
       );",Untyped,"function ff_redirect($url, $target='self', $method='post')
{
    global $ff_processor, $ff_request;
    if ($ff_processor->dying) return;

    ob_end_clean();
    switch (strtolower($method)) {
        case 'get': {
            switch (strtolower($target)) {
                case 'top'   :
                case 'parent': break;
                default      : $target = 'document';
            } // switch
            echo '<script type=""text/javascript"">'.nl().
                 '<!--'.nl().
                 ""onload=function() { "".$target."".location.href='"".$url.""'; }"".nl().
                 '-->'.nl().
                 '</script>'.nl().
                 '</body>'.nl();
            break;
        } // url
        default: { // post
            $pos = strpos($url,'?');
            $ff_request = array();
            if ($pos === false)
                $action = $url;
            else {
                $action = substr($url,0,$pos);
                addRequestParams(substr($url, $pos+1));
            } // if
            switch (strtolower($target)) {
                case 'blank' : $target = ' target=""_blank""';  break;
                case 'top'   : $target = ' target=""_top""';    break;
                case 'parent': $target = ' target=""_parent""'; break;
                default      : $target = ' target=""_self""';
            } // switch
            echo '<script language=""javascript"" type=""text/javascript"">'.nl().
                 '<!--'.nl().
                 'onload = function() { document.ff_redirect.submit(); }'.nl().
                 '-->'.nl().
                 '</script>'.nl().
                 '<form action=""'.$action.'"" '.
                  'method=""post"" '.
                  'name=""ff_redirect"" id=""ff_redirect"" '.
                  'enctype=""multipart/form-data""'.
                  $target.
                 '>'.nl();
            while (list($prop, $val) = each($ff_request))
                echo '<input type=""hidden"" name=""'.$prop.'"" '.
                            'value=""'.htmlentities(urldecode($val)).'""/>'.nl();
            echo '</form>'.nl().
                 '</body>'.nl();
        } // post
    } // switch
    exit;
} // ff_redirect"
18,1,FF,ff_redirectForm,Redirect to other form,"Redirects to another facile form. 

Call: 

    ff_redirectForm($name, $params = '');

Example:

    ff_redirectForm(
        $this, 
       'SecondForm', 
       '&ff_param_email='.urlencode($email)
    );",Untyped,"function ff_redirectForm($name, $params='', $method='post')
{
    ff_redirectParent(ff_makeFormUrl($name, $params), $method);
} // ff_redirectForm"
19,1,FF,ff_redirectPage,Redirect to other page,"Redirects to another mambo page. 

Call: 

    ff_redirectPage($params = '');

Example:

    ff_redirectPage(
        'index.php?option=com_content&task=blogsection&id=0&Itemid=39'
    );",Untyped,"function ff_redirectPage($params='', $method='post')
{
    ff_redirectParent(ff_makePageUrl($params), $method);
} // ff_redirectPage"
20,1,FF,ff_redirectParentX,Redirect to parent window,"Redirects to the parent window when runing in iframe, otherwise to self. 

ff_redirectParent($url [, $method='post'])

    $url    = The url to redirect to including the parameters appended.

    $method = 'post' or 'url'. The default is 'post'.

    Example:

       ff_redirectParent(
          'http://mysite.net/index.php?option=xxx&Itemid=33',
          'url'
       );",Untyped,"function ff_redirectParent($url, $method = 'post')
{
    global $ff_processor;
    if ($ff_processor->inframe) $target = 'parent'; else $target = 'self'; 
    ff_redirect($url, $target, $method);
} // ff_redirectParent"
21,1,FF,ff_redirectSelf,Redirect to same form,"Redirects to the same form. 

Call: 

    ff_redirectSelf($params = '');

Example:

    ff_redirectSelf('&ff_param_email='.urlencode($email));",Untyped,"function ff_redirectSelf($params='', $method='post')
{
    ff_redirectParent(ff_makeSelfUrl($params), $method);
} // ff_redirectSelf"
22,1,FF,ff_securityImage,Security Image,Create code to display the security image,Untyped,"global $ff_seccode;

if (!isset($this->record_id)) { $ff_seccode = null; }

function ff_securityImage()
{
    global $ff_comsite, $ff_seccode;
    if (!isset($ff_seccode)) { 
        mt_srand((double)microtime()*1000000);
        $ff_seccode = mt_rand(10000, 99999);
        JFactory::getSession()->set('ff_seccode', $ff_seccode);
    } // if

    return '<img src=""'.JURI::root().'ff_secimage.php?option=com_breezingforms&showSecImage=true"" title="""" alt="""" />';
} // ff_securityImage"
23,1,FF,ff_select,Select rows from db,"Execute a select query

Include by one of:

    $this->execPieceByName('ff_InitUtilities');
    $this->execPieceByName('ff_SubmitUtilities');
    if (!function_exists('ff_select')) $this->execPieceByName('ff_select');

Call syntax:

    $rows = ff_select($sql);

    $sql:    Sql SELECT-statement to call
    $rows:   List of row objects",Untyped,"function ff_select($sql, $error=FF_DIE)
{
    $database = JFactory::getDBO();
    $database->setQuery($sql);
    $rows = $database->loadObjectList();
    if ($database->getErrorNum()) {
        $dienow = $error==FF_DIE;
        $error = $database->stderr();
        $rows = array();
        if ($dienow) ff_die($error);
    } else
        $error = null;
    return $rows;
} // ff_select"
24,1,FF,ff_selectValue,Select single value from db,"Execute query to read a single value

Include by one of:

    $this->execPieceByName('ff_InitUtilities');
    $this->execPieceByName('ff_SubmitUtilities');
    if (!function_exists('ff_selectValue')) $this->execPieceByName('ff_selectValue');

Call syntax:

    $value = ff_selectValue($sql);

    $sql:    Sql SELECT-statement to call
    $value:  The value returned by the database",Untyped,"function ff_selectValue($sql, $def=null, $error=FF_DIE)
{
    $database = JFactory::getDBO();
    $database->setQuery($sql);
    $value = $database->loadResult();
    if ($database->getErrorNum()) {
        $dienow = $error==FF_DIE;
        $error = $database->stderr();
        if ($dienow) ff_die($error);
    } else {
        $error = null;
        if ($value) return $value;
    } // if
    return $def;
} // ff_selectValue"
25,1,FF,ff_setCheckedX,Set checkbox/radiobutton checked,"Set a radio button or checkbox checked. 

Call: 

    ff_setChecked('name', 'value');",Untyped,"function ff_setChecked($name, $value)
{
    global $ff_processor;
    for ($r = 0; $r < $ff_processor->rowcount; $r++) {
        $row =& $ff_processor->rows[$r];
        if ($row->name==$name && $row->data1==$value)
            $row->flag1 = 1;
        unset($row);
    } // for
} // ff_setChecked"
26,1,FF,ff_setSelectedX,Set a select list option to *selected*,"Sets a select list option to selected. 

Call: 

    ff_setSelected('name', 'value');",Untyped,"function ff_setSelected($name, $value)
{
    global $ff_processor;
    for ($r = 0; $r < $ff_processor->rowcount; $r++) {
        $row =& $ff_processor->rows[$r];
        if ($row->name==$name)
            $row->data2 =
                preg_replace(
                    '/(^|\r\n|\n)(0|1);([^;]*);('.$value.')($|\r\n|\n)/',
                    '${1}1;${3};${4}${5}',
                    $row->data2
                );
        unset($row);
    } // for
} // ff_setSelected"
27,1,FF,ff_setValueX,"Set text, textarea, hidden value","Set value of a Static Text, Text, Textarea or Hidden Input. 

Call: 

    ff_setValue('name', 'value');",Untyped,"function ff_setValue($name, $value)
{
    global $ff_processor;
    for ($r = 0; $r < $ff_processor->rowcount; $r++) {
        $row =& $ff_processor->rows[$r];
        if ($row->name==$name)
            $row->data1 = $value;
        unset($row);
    } // for
} // ff_setValue"
28,1,FF,Markdown,Original Markdown Processor,"Converts text marked up by 'Markdown' into HTML.

Please use ff_markdown() in forms instead of Markdown()",Untyped,"#
# Markdown  -  A text-to-HTML conversion tool for web writers
#
# Copyright (c) 2004-2005 John Gruber
# <http://daringfireball.net/projects/markdown/>
#
# Copyright (c) 2004-2005 Michel Fortin - PHP Port
# <http://www.michelf.com/projects/php-markdown/>
#

global	$MarkdownPHPVersion, $MarkdownSyntaxVersion,
		$md_empty_element_suffix, $md_tab_width,
		$md_nested_brackets_depth, $md_nested_brackets,
		$md_escape_table, $md_backslash_escape_table,
		$md_list_level;

$MarkdownPHPVersion    = '1.0.1b'; # Mon 6 Jun 2005
$MarkdownSyntaxVersion = '1.0.1';  # Sun 12 Dec 2004


#
# Global default settings:
#
$md_empty_element_suffix = "" />"";     # Change to "">"" for HTML output
$md_tab_width = 4;

#
# WordPress settings:
#
$md_wp_posts    = true;  # Set to false to remove Markdown from posts.
$md_wp_comments = true;  # Set to false to remove Markdown from comments.


# -- WordPress Plugin Interface -----------------------------------------------
/*
Plugin Name: Markdown
Plugin URI: http://www.michelf.com/projects/php-markdown/
Description: <a href=""http://daringfireball.net/projects/markdown/syntax"">Markdown syntax</a> allows you to write using an easy-to-read, easy-to-write plain text format. Based on the original Perl version by <a href=""http://daringfireball.net/"">John Gruber</a>. <a href=""http://www.michelf.com/projects/php-markdown/"">More...</a>
Version: 1.0.1b
Author: Michel Fortin
Author URI: http://www.michelf.com/
*/
if (isset($wp_version)) {
	# More details about how it works here:
	# <http://www.michelf.com/weblog/2005/wordpress-text-flow-vs-markdown/>

	# Post content and excerpts
	if ($md_wp_posts) {
		remove_filter('the_content',  'wpautop');
		remove_filter('the_excerpt',  'wpautop');
		add_filter('the_content',     'Markdown', 6);
		add_filter('get_the_excerpt', 'Markdown', 6);
		add_filter('get_the_excerpt', 'trim', 7);
		add_filter('the_excerpt',     'md_add_p');
		add_filter('the_excerpt_rss', 'md_strip_p');

		remove_filter('content_save_pre',  'balanceTags', 50);
		remove_filter('excerpt_save_pre',  'balanceTags', 50);
		add_filter('the_content',  	  'balanceTags', 50);
		add_filter('get_the_excerpt', 'balanceTags', 9);

		function md_add_p($text) {
			if (strlen($text) == 0) return;
			if (strcasecmp(substr($text, -3), '<p>') == 0) return $text;
			return '<p>'.$text.'</p>';
		}
		function md_strip_p($t) { return preg_replace('{</?[pP]>}', '', $t); }
	}

	# Comments
	if ($md_wp_comments) {
		remove_filter('comment_text', 'wpautop');
		remove_filter('comment_text', 'make_clickable');
		add_filter('pre_comment_content', 'Markdown', 6);
		add_filter('pre_comment_content', 'md_hide_tags', 8);
		add_filter('pre_comment_content', 'md_show_tags', 12);
		add_filter('get_comment_text',    'Markdown', 6);
		add_filter('get_comment_excerpt', 'Markdown', 6);
		add_filter('get_comment_excerpt', 'md_strip_p', 7);

		global $md_hidden_tags;
		$md_hidden_tags = array(
			'<p>'	=> md5('<p>'),		'</p>'	=> md5('</p>'),
			'<pre>'	=> md5('<pre>'),	'</pre>'=> md5('</pre>'),
			'<ol>'	=> md5('<ol>'),		'</ol>'	=> md5('</ol>'),
			'<ul>'	=> md5('<ul>'),		'</ul>'	=> md5('</ul>'),
			'<li>'	=> md5('<li>'),		'</li>'	=> md5('</li>'),
			);

		function md_hide_tags($text) {
			global $md_hidden_tags;
			return str_replace(array_keys($md_hidden_tags),
								array_values($md_hidden_tags), $text);
		}
		function md_show_tags($text) {
			global $md_hidden_tags;
			return str_replace(array_values($md_hidden_tags),
								array_keys($md_hidden_tags), $text);
		}
	}
}


# -- bBlog Plugin Info --------------------------------------------------------
function identify_modifier_markdown() {
	global $MarkdownPHPVersion;
	return array(
		'name'			=> 'markdown',
		'type'			=> 'modifier',
		'nicename'		=> 'Markdown',
		'description'	=> 'A text-to-HTML conversion tool for web writers',
		'authors'		=> 'Michel Fortin and John Gruber',
		'licence'		=> 'GPL',
		'version'		=> $MarkdownPHPVersion,
		'help'			=> '<a href=""http://daringfireball.net/projects/markdown/syntax"">Markdown syntax</a> allows you to write using an easy-to-read, easy-to-write plain text format. Based on the original Perl version by <a href=""http://daringfireball.net/"">John Gruber</a>. <a href=""http://www.michelf.com/projects/php-markdown/"">More...</a>'
	);
}

# -- Smarty Modifier Interface ------------------------------------------------
function smarty_modifier_markdown($text) {
	return Markdown($text);
}

# -- Textile Compatibility Mode -----------------------------------------------
# Rename this file to ""classTextile.php"" and it can replace Textile anywhere.
if (strcasecmp(substr(__FILE__, -16), ""classTextile.php"") == 0) {
	# Try to include PHP SmartyPants. Should be in the same directory.
	@include_once 'smartypants.php';
	# Fake Textile class. It calls Markdown instead.
	class Textile {
		function TextileThis($text, $lite='', $encode='', $noimage='', $strict='') {
			if ($lite == '' && $encode == '')   $text = Markdown($text);
			if (function_exists('SmartyPants')) $text = SmartyPants($text);
			return $text;
		}
	}
}



#
# Globals:
#

# Regex to match balanced [brackets].
# Needed to insert a maximum bracked depth while converting to PHP.
$md_nested_brackets_depth = 6;
$md_nested_brackets =
	str_repeat('(?>[^\[\]]+|\[', $md_nested_brackets_depth).
	str_repeat('\])*', $md_nested_brackets_depth);

# Table of hash values for escaped characters:
$md_escape_table = array(
	""\\"" => md5(""\\""),
	""`"" => md5(""`""),
	""*"" => md5(""*""),
	""_"" => md5(""_""),
	""{"" => md5(""{""),
	""}"" => md5(""}""),
	""["" => md5(""[""),
	""]"" => md5(""]""),
	""("" => md5(""(""),
	"")"" => md5("")""),
	"">"" => md5("">""),
	""#"" => md5(""#""),
	""+"" => md5(""+""),
	""-"" => md5(""-""),
	""."" => md5("".""),
	""!"" => md5(""!"")
);
# Create an identical table but for escaped characters.
$md_backslash_escape_table;
foreach ($md_escape_table as $key => $char)
	$md_backslash_escape_table[""\\$key""] = $char;


function Markdown($text) {
#
# Main function. The order in which other subs are called here is
# essential. Link and image substitutions need to happen before
# _EscapeSpecialCharsWithinTagAttributes(), so that any *'s or _'s in the <a>
# and <img> tags get encoded.
#
	# Clear the global hashes. If we don't clear these, you get conflicts
	# from other articles when generating a page which contains more than
	# one article (e.g. an index page that shows the N most recent
	# articles):
	global $md_urls, $md_titles, $md_html_blocks;
	$md_urls = array();
	$md_titles = array();
	$md_html_blocks = array();

	# Standardize line endings:
	#   DOS to Unix and Mac to Unix
	$text = str_replace(array(""\r\n"", ""\r""), ""\n"", $text);

	# Make sure $text ends with a couple of newlines:
	$text .= ""\n\n"";

	# Convert all tabs to spaces.
	$text = _Detab($text);

	# Strip any lines consisting only of spaces and tabs.
	# This makes subsequent regexen easier to write, because we can
	# match consecutive blank lines with /\n+/ instead of something
	# contorted like /[ \t]*\n+/ .
	$text = preg_replace('/^[ \t]+$/m', '', $text);

	# Turn block-level HTML blocks into hash entries
	$text = _HashHTMLBlocks($text);

	# Strip link definitions, store in hashes.
	$text = _StripLinkDefinitions($text);

	$text = _RunBlockGamut($text);

	$text = _UnescapeSpecialChars($text);

	return $text . ""\n"";
}


function _StripLinkDefinitions($text) {
#
# Strips link definitions from text, stores the URLs and titles in
# hash references.
#
	global $md_tab_width;
	$less_than_tab = $md_tab_width - 1;

	# Link defs are in the form: ^[id]: url ""optional title""
	$text = preg_replace_callback('{
						^[ ]{0,'.$less_than_tab.'}\[(.+)\]:	# id = $1
						  [ \t]*
						  \n?				# maybe *one* newline
						  [ \t]*
						<?(\S+?)>?			# url = $2
						  [ \t]*
						  \n?				# maybe one newline
						  [ \t]*
						(?:
							(?<=\s)			# lookbehind for whitespace
							[""(]
							(.+?)			# title = $3
							["")]
							[ \t]*
						)?	# title is optional
						(?:\n+|\Z)
		}xm',
		'_StripLinkDefinitions_callback',
		$text);
	return $text;
}
function _StripLinkDefinitions_callback($matches) {
	global $md_urls, $md_titles;
	$link_id = strtolower($matches[1]);
	$md_urls[$link_id] = _EncodeAmpsAndAngles($matches[2]);
	if (isset($matches[3]))
		$md_titles[$link_id] = str_replace('""', '&quot;', $matches[3]);
	return ''; # String that will replace the block
}


function _HashHTMLBlocks($text) {
	global $md_tab_width;
	$less_than_tab = $md_tab_width - 1;

	# Hashify HTML blocks:
	# We only want to do this for block-level HTML tags, such as headers,
	# lists, and tables. That's because we still want to wrap <p>s around
	# ""paragraphs"" that are wrapped in non-block-level tags, such as anchors,
	# phrase emphasis, and spans. The list of tags we're looking for is
	# hard-coded:
	$block_tags_a = 'p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|'.
					'script|noscript|form|fieldset|iframe|math|ins|del';
	$block_tags_b = 'p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|'.
					'script|noscript|form|fieldset|iframe|math';

	# First, look for nested blocks, e.g.:
	# 	<div>
	# 		<div>
	# 		tags for inner block must be indented.
	# 		</div>
	# 	</div>
	#
	# The outermost tags must start at the left margin for this to match, and
	# the inner nested divs must be indented.
	# We need to do this before the next, more liberal match, because the next
	# match will start at the first `<div>` and stop at the first `</div>`.
	$text = preg_replace_callback(""{
				(						# save in $1
					^					# start of line  (with /m)
					<($block_tags_a)	# start tag = $2
					\\b					# word break
					(.*\\n)*?			# any number of lines, minimally matching
					</\\2>				# the matching end tag
					[ \\t]*				# trailing spaces/tabs
					(?=\\n+|\\Z)	# followed by a newline or end of document
				)
		}xm"",
		'_HashHTMLBlocks_callback',
		$text);

	#
	# Now match more liberally, simply from `\n<tag>` to `</tag>\n`
	#
	$text = preg_replace_callback(""{
				(						# save in $1
					^					# start of line  (with /m)
					<($block_tags_b)	# start tag = $2
					\\b					# word break
					(.*\\n)*?			# any number of lines, minimally matching
					.*</\\2>				# the matching end tag
					[ \\t]*				# trailing spaces/tabs
					(?=\\n+|\\Z)	# followed by a newline or end of document
				)
		}xm"",
		'_HashHTMLBlocks_callback',
		$text);

	# Special case just for <hr />. It was easier to make a special case than
	# to make the other regex more complicated.
	$text = preg_replace_callback('{
				(?:
					(?<=\n\n)		# Starting after a blank line
					|				# or
					\A\n?			# the beginning of the doc
				)
				(						# save in $1
					[ ]{0,'.$less_than_tab.'}
					<(hr)				# start tag = $2
					\b					# word break
					([^<>])*?			#
					/?>					# the matching end tag
					[ \t]*
					(?=\n{2,}|\Z)		# followed by a blank line or end of document
				)
		}x',
		'_HashHTMLBlocks_callback',
		$text);

	# Special case for standalone HTML comments:
	$text = preg_replace_callback('{
				(?:
					(?<=\n\n)		# Starting after a blank line
					|				# or
					\A\n?			# the beginning of the doc
				)
				(						# save in $1
					[ ]{0,'.$less_than_tab.'}
					(?s:
						<!
						(--.*?--\s*)+
						>
					)
					[ \t]*
					(?=\n{2,}|\Z)		# followed by a blank line or end of document
				)
			}x',
			'_HashHTMLBlocks_callback',
			$text);

	return $text;
}
function _HashHTMLBlocks_callback($matches) {
	global $md_html_blocks;
	$text = $matches[1];
	$key = md5($text);
	$md_html_blocks[$key] = $text;
	return ""\n\n$key\n\n""; # String that will replace the block
}


function _RunBlockGamut($text) {
#
# These are all the transformations that form block-level
# tags like paragraphs, headers, and list items.
#
	global $md_empty_element_suffix;

	$text = _DoHeaders($text);

	# Do Horizontal Rules:
	$text = preg_replace(
		array('{^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$}mx',
			  '{^[ ]{0,2}([ ]? -[ ]?){3,}[ \t]*$}mx',
			  '{^[ ]{0,2}([ ]? _[ ]?){3,}[ \t]*$}mx'),
		""\n<hr$md_empty_element_suffix\n"",
		$text);

	$text = _DoLists($text);
	$text = _DoCodeBlocks($text);
	$text = _DoBlockQuotes($text);

	# We already ran _HashHTMLBlocks() before, in Markdown(), but that
	# was to escape raw HTML in the original Markdown source. This time,
	# we're escaping the markup we've just created, so that we don't wrap
	# <p> tags around block-level tags.
	$text = _HashHTMLBlocks($text);
	$text = _FormParagraphs($text);

	return $text;
}


function _RunSpanGamut($text) {
#
# These are all the transformations that occur *within* block-level
# tags like paragraphs, headers, and list items.
#
	global $md_empty_element_suffix;

	$text = _DoCodeSpans($text);

	$text = _EscapeSpecialChars($text);

	# Process anchor and image tags. Images must come first,
	# because ![foo][f] looks like an anchor.
	$text = _DoImages($text);
	$text = _DoAnchors($text);

	# Make links out of things like `<http://example.com/>`
	# Must come after _DoAnchors(), because you can use < and >
	# delimiters in inline links like [this](<url>).
	$text = _DoAutoLinks($text);
	$text = _EncodeAmpsAndAngles($text);
	$text = _DoItalicsAndBold($text);

	# Do hard breaks:
	$text = preg_replace('/ {2,}\n/', ""<br$md_empty_element_suffix\n"", $text);

	return $text;
}


function _EscapeSpecialChars($text) {
	global $md_escape_table;
	$tokens = _TokenizeHTML($text);

	$text = '';   # rebuild $text from the tokens
#	$in_pre = 0;  # Keep track of when we're inside <pre> or <code> tags.
#	$tags_to_skip = ""!<(/?)(?:pre|code|kbd|script|math)[\s>]!"";

	foreach ($tokens as $cur_token) {
		if ($cur_token[0] == 'tag') {
			# Within tags, encode * and _ so they don't conflict
			# with their use in Markdown for italics and strong.
			# We're replacing each such character with its
			# corresponding MD5 checksum value; this is likely
			# overkill, but it should prevent us from colliding
			# with the escape values by accident.
			$cur_token[1] = str_replace(array('*', '_'),
				array($md_escape_table['*'], $md_escape_table['_']),
				$cur_token[1]);
			$text .= $cur_token[1];
		} else {
			$t = $cur_token[1];
			$t = _EncodeBackslashEscapes($t);
			$text .= $t;
		}
	}
	return $text;
}


function _DoAnchors($text) {
#
# Turn Markdown link shortcuts into XHTML <a> tags.
#
	global $md_nested_brackets;
	#
	# First, handle reference-style links: [link text] [id]
	#
	$text = preg_replace_callback(""{
		(					# wrap whole match in $1
		  \\[
			($md_nested_brackets)	# link text = $2
		  \\]

		  [ ]?				# one optional space
		  (?:\\n[ ]*)?		# one optional newline followed by spaces

		  \\[
			(.*?)		# id = $3
		  \\]
		)
		}xs"",
		'_DoAnchors_reference_callback', $text);

	#
	# Next, inline-style links: [link text](url ""optional title"")
	#
	$text = preg_replace_callback(""{
		(				# wrap whole match in $1
		  \\[
			($md_nested_brackets)	# link text = $2
		  \\]
		  \\(			# literal paren
			[ \\t]*
			<?(.*?)>?	# href = $3
			[ \\t]*
			(			# $4
			  (['\""])	# quote char = $5
			  (.*?)		# Title = $6
			  \\5		# matching quote
			)?			# title is optional
		  \\)
		)
		}xs"",
		'_DoAnchors_inline_callback', $text);

	return $text;
}
function _DoAnchors_reference_callback($matches) {
	global $md_urls, $md_titles, $md_escape_table;
	$whole_match = $matches[1];
	$link_text   = $matches[2];
	$link_id     = strtolower($matches[3]);

	if ($link_id == """") {
		$link_id = strtolower($link_text); # for shortcut links like [this][].
	}

	if (isset($md_urls[$link_id])) {
		$url = $md_urls[$link_id];
		# We've got to encode these to avoid conflicting with italics/bold.
		$url = str_replace(array('*', '_'),
						   array($md_escape_table['*'], $md_escape_table['_']),
						   $url);
		$result = ""<a href=\""$url\"""";
		if ( isset( $md_titles[$link_id] ) ) {
			$title = $md_titles[$link_id];
			$title = str_replace(array('*',     '_'),
								 array($md_escape_table['*'],
									   $md_escape_table['_']), $title);
			$result .=  "" title=\""$title\"""";
		}
		$result .= "">$link_text</a>"";
	}
	else {
		$result = $whole_match;
	}
	return $result;
}
function _DoAnchors_inline_callback($matches) {
	global $md_escape_table;
	$whole_match	= $matches[1];
	$link_text		= $matches[2];
	$url			= $matches[3];
	$title			=& $matches[6];

	# We've got to encode these to avoid conflicting with italics/bold.
	$url = str_replace(array('*', '_'),
					   array($md_escape_table['*'], $md_escape_table['_']),
					   $url);
	$result = ""<a href=\""$url\"""";
	if (isset($title)) {
		$title = str_replace('""', '&quot;', $title);
		$title = str_replace(array('*', '_'),
							 array($md_escape_table['*'], $md_escape_table['_']),
							 $title);
		$result .=  "" title=\""$title\"""";
	}

	$result .= "">$link_text</a>"";

	return $result;
}


function _DoImages($text) {
#
# Turn Markdown image shortcuts into <img> tags.
#
	global $md_nested_brackets;

	#
	# First, handle reference-style labeled images: ![alt text][id]
	#
	$text = preg_replace_callback('{
		(				# wrap whole match in $1
		  !\[
			('.$md_nested_brackets.')		# alt text = $2
		  \]

		  [ ]?				# one optional space
		  (?:\n[ ]*)?		# one optional newline followed by spaces

		  \[
			(.*?)		# id = $3
		  \]

		)
		}xs',
		'_DoImages_reference_callback', $text);

	#
	# Next, handle inline images:  ![alt text](url ""optional title"")
	# Don't forget: encode * and _

	$text = preg_replace_callback('{
		(				# wrap whole match in $1
		  !\[
			('.$md_nested_brackets.')		# alt text = $2
		  \]
		  \(			# literal paren
			[ \t]*
			<?(\S+?)>?	# src url = $3
			[ \t]*
			(			# $4
			  ([\'""])	# quote char = $5
			  (.*?)		# title = $6
			  \5		# matching quote
			  [ \t]*
			)?			# title is optional
		  \)
		)
		}xs',
		'_DoImages_inline_callback', $text);

	return $text;
}
function _DoImages_reference_callback($matches) {
	global $md_urls, $md_titles, $md_empty_element_suffix, $md_escape_table;
	$whole_match = $matches[1];
	$alt_text    = $matches[2];
	$link_id     = strtolower($matches[3]);

	if ($link_id == """") {
		$link_id = strtolower($alt_text); # for shortcut links like ![this][].
	}

	$alt_text = str_replace('""', '&quot;', $alt_text);
	if (isset($md_urls[$link_id])) {
		$url = $md_urls[$link_id];
		# We've got to encode these to avoid conflicting with italics/bold.
		$url = str_replace(array('*', '_'),
						   array($md_escape_table['*'], $md_escape_table['_']),
						   $url);
		$result = ""<img src=\""$url\"" alt=\""$alt_text\"""";
		if (isset($md_titles[$link_id])) {
			$title = $md_titles[$link_id];
			$title = str_replace(array('*', '_'),
								 array($md_escape_table['*'],
									   $md_escape_table['_']), $title);
			$result .=  "" title=\""$title\"""";
		}
		$result .= $md_empty_element_suffix;
	}
	else {
		# If there's no such link ID, leave intact:
		$result = $whole_match;
	}

	return $result;
}
function _DoImages_inline_callback($matches) {
	global $md_empty_element_suffix, $md_escape_table;
	$whole_match	= $matches[1];
	$alt_text		= $matches[2];
	$url			= $matches[3];
	$title			= '';
	if (isset($matches[6])) {
		$title		= $matches[6];
	}

	$alt_text = str_replace('""', '&quot;', $alt_text);
	$title    = str_replace('""', '&quot;', $title);
	# We've got to encode these to avoid conflicting with italics/bold.
	$url = str_replace(array('*', '_'),
					   array($md_escape_table['*'], $md_escape_table['_']),
					   $url);
	$result = ""<img src=\""$url\"" alt=\""$alt_text\"""";
	if (isset($title)) {
		$title = str_replace(array('*', '_'),
							 array($md_escape_table['*'], $md_escape_table['_']),
							 $title);
		$result .=  "" title=\""$title\""""; # $title already quoted
	}
	$result .= $md_empty_element_suffix;

	return $result;
}


function _DoHeaders($text) {
	# Setext-style headers:
	#	  Header 1
	#	  ========
	#
	#	  Header 2
	#	  --------
	#
	$text = preg_replace(
		array('{ ^(.+)[ \t]*\n=+[ \t]*\n+ }emx',
			  '{ ^(.+)[ \t]*\n-+[ \t]*\n+ }emx'),
		array(""'<h1>'._RunSpanGamut(_UnslashQuotes('\\1')).'</h1>\n\n'"",
			  ""'<h2>'._RunSpanGamut(_UnslashQuotes('\\1')).'</h2>\n\n'""),
		$text);

	# atx-style headers:
	#	# Header 1
	#	## Header 2
	#	## Header 2 with closing hashes ##
	#	...
	#	###### Header 6
	#
	$text = preg_replace(""{
			^(\\#{1,6})	# $1 = string of #'s
			[ \\t]*
			(.+?)		# $2 = Header text
			[ \\t]*
			\\#*			# optional closing #'s (not counted)
			\\n+
		}xme"",
		""'<h'.strlen('\\1').'>'._RunSpanGamut(_UnslashQuotes('\\2')).'</h'.strlen('\\1').'>\n\n'"",
		$text);

	return $text;
}


function _DoLists($text) {
#
# Form HTML ordered (numbered) and unordered (bulleted) lists.
#
	global $md_tab_width, $md_list_level;
	$less_than_tab = $md_tab_width - 1;

	# Re-usable patterns to match list item bullets and number markers:
	$marker_ul  = '[*+-]';
	$marker_ol  = '\d+[.]';
	$marker_any = ""(?:$marker_ul|$marker_ol)"";

	$markers = array($marker_ul, $marker_ol);

	foreach ($markers as $marker) {
		# Re-usable pattern to match any entirel ul or ol list:
		$whole_list = '
			(								# $1 = whole list
			  (								# $2
				[ ]{0,'.$less_than_tab.'}
				('.$marker.')				# $3 = first list item marker
				[ \t]+
			  )
			  (?s:.+?)
			  (								# $4
				  \z
				|
				  \n{2,}
				  (?=\S)
				  (?!						# Negative lookahead for another list item marker
					[ \t]*
					'.$marker.'[ \t]+
				  )
			  )
			)
		'; // mx

		# We use a different prefix before nested lists than top-level lists.
		# See extended comment in _ProcessListItems().

		if ($md_list_level) {
			$text = preg_replace_callback('{
					^
					'.$whole_list.'
				}mx',
				'_DoLists_callback_top', $text);
		}
		else {
			$text = preg_replace_callback('{
					(?:(?<=\n\n)|\A\n?)
					'.$whole_list.'
				}mx',
				'_DoLists_callback_nested', $text);
		}
	}

	return $text;
}
function _DoLists_callback_top($matches) {
	# Re-usable patterns to match list item bullets and number markers:
	$marker_ul  = '[*+-]';
	$marker_ol  = '\d+[.]';
	$marker_any = ""(?:$marker_ul|$marker_ol)"";

	$list = $matches[1];
	$list_type = preg_match(""/$marker_ul/"", $matches[3]) ? ""ul"" : ""ol"";

	$marker_any = ( $list_type == ""ul"" ? $marker_ul : $marker_ol );

	# Turn double returns into triple returns, so that we can make a
	# paragraph for the last item in a list, if necessary:
	$list = preg_replace(""/\n{2,}/"", ""\n\n\n"", $list);
	$result = _ProcessListItems($list, $marker_any);

	# Trim any trailing whitespace, to put the closing `</$list_type>`
	# up on the preceding line, to get it past the current stupid
	# HTML block parser. This is a hack to work around the terrible
	# hack that is the HTML block parser.
	$result = rtrim($result);
	$result = ""<$list_type>"" . $result . ""</$list_type>\n"";
	return $result;
}
function _DoLists_callback_nested($matches) {
	# Re-usable patterns to match list item bullets and number markers:
	$marker_ul  = '[*+-]';
	$marker_ol  = '\d+[.]';
	$marker_any = ""(?:$marker_ul|$marker_ol)"";

	$list = $matches[1];
	$list_type = preg_match(""/$marker_ul/"", $matches[3]) ? ""ul"" : ""ol"";

	$marker_any = ( $list_type == ""ul"" ? $marker_ul : $marker_ol );

	# Turn double returns into triple returns, so that we can make a
	# paragraph for the last item in a list, if necessary:
	$list = preg_replace(""/\n{2,}/"", ""\n\n\n"", $list);
	$result = _ProcessListItems($list, $marker_any);
	$result = ""<$list_type>\n"" . $result . ""</$list_type>\n"";
	return $result;
}


function _ProcessListItems($list_str, $marker_any) {
#
#	Process the contents of a single ordered or unordered list, splitting it
#	into individual list items.
#
	global $md_list_level;

	# The $md_list_level global keeps track of when we're inside a list.
	# Each time we enter a list, we increment it; when we leave a list,
	# we decrement. If it's zero, we're not in a list anymore.
	#
	# We do this because when we're not inside a list, we want to treat
	# something like this:
	#
	#		I recommend upgrading to version
	#		8. Oops, now this line is treated
	#		as a sub-list.
	#
	# As a single paragraph, despite the fact that the second line starts
	# with a digit-period-space sequence.
	#
	# Whereas when we're inside a list (or sub-list), that line will be
	# treated as the start of a sub-list. What a kludge, huh? This is
	# an aspect of Markdown's syntax that's hard to parse perfectly
	# without resorting to mind-reading. Perhaps the solution is to
	# change the syntax rules such that sub-lists must start with a
	# starting cardinal number; e.g. ""1."" or ""a."".

	$md_list_level++;

	# trim trailing blank lines:
	$list_str = preg_replace(""/\n{2,}\\z/"", ""\n"", $list_str);

	$list_str = preg_replace_callback('{
		(\n)?							# leading line = $1
		(^[ \t]*)						# leading whitespace = $2
		('.$marker_any.') [ \t]+		# list marker = $3
		((?s:.+?)						# list item text   = $4
		(\n{1,2}))
		(?= \n* (\z | \2 ('.$marker_any.') [ \t]+))
		}xm',
		'_ProcessListItems_callback', $list_str);

	$md_list_level--;
	return $list_str;
}
function _ProcessListItems_callback($matches) {
	$item = $matches[4];
	$leading_line =& $matches[1];
	$leading_space =& $matches[2];

	if ($leading_line || preg_match('/\n{2,}/', $item)) {
		$item = _RunBlockGamut(_Outdent($item));
	}
	else {
		# Recursion for sub-lists:
		$item = _DoLists(_Outdent($item));
		$item = preg_replace('/\n+$/', '', $item);
		$item = _RunSpanGamut($item);
	}

	return ""<li>"" . $item . ""</li>\n"";
}


function _DoCodeBlocks($text) {
#
#	Process Markdown `<pre><code>` blocks.
#
	global $md_tab_width;
	$text = preg_replace_callback(""{
			(?:\\n\\n|\\A)
			(	            # $1 = the code block -- one or more lines, starting with a space/tab
			  (?:
				(?:[ ]\{$md_tab_width} | \\t)  # Lines must start with a tab or a tab-width of spaces
				.*\\n+
			  )+
			)
			((?=^[ ]{0,$md_tab_width}\\S)|\\Z)	# Lookahead for non-space at line-start, or end of doc
		}xm"",
		'_DoCodeBlocks_callback', $text);

	return $text;
}
function _DoCodeBlocks_callback($matches) {
	$codeblock = $matches[1];

	$codeblock = _EncodeCode(_Outdent($codeblock));
//	$codeblock = _Detab($codeblock);
	# trim leading newlines and trailing whitespace
	$codeblock = preg_replace(array('/\A\n+/', '/\s+\z/'), '', $codeblock);

	$result = ""\n\n<pre><code>"" . $codeblock . ""\n</code></pre>\n\n"";

	return $result;
}


function _DoCodeSpans($text) {
#
# 	*	Backtick quotes are used for <code></code> spans.
#
# 	*	You can use multiple backticks as the delimiters if you want to
# 		include literal backticks in the code span. So, this input:
#
#		  Just type ``foo `bar` baz`` at the prompt.
#
#	  	Will translate to:
#
#		  <p>Just type <code>foo `bar` baz</code> at the prompt.</p>
#
#		There's no arbitrary limit to the number of backticks you
#		can use as delimters. If you need three consecutive backticks
#		in your code, use four for delimiters, etc.
#
#	*	You can use spaces to get literal backticks at the edges:
#
#		  ... type `` `bar` `` ...
#
#	  	Turns to:
#
#		  ... type <code>`bar`</code> ...
#
	$text = preg_replace_callback('@
			(?<!\\\)	# Character before opening ` can\'t be a backslash
			(`+)		# $1 = Opening run of `
			(.+?)		# $2 = The code block
			(?<!`)
			\1			# Matching closer
			(?!`)
		@xs',
		'_DoCodeSpans_callback', $text);

	return $text;
}
function _DoCodeSpans_callback($matches) {
	$c = $matches[2];
	$c = preg_replace('/^[ \t]*/', '', $c); # leading whitespace
	$c = preg_replace('/[ \t]*$/', '', $c); # trailing whitespace
	$c = _EncodeCode($c);
	return ""<code>$c</code>"";
}


function _EncodeCode($_) {
#
# Encode/escape certain characters inside Markdown code runs.
# The point is that in code, these characters are literals,
# and lose their special Markdown meanings.
#
	global $md_escape_table;

	# Encode all ampersands; HTML entities are not
	# entities within a Markdown code span.
	$_ = str_replace('&', '&amp;', $_);

	# Do the angle bracket song and dance:
	$_ = str_replace(array('<',    '>'),
					 array('&lt;', '&gt;'), $_);

	# Now, escape characters that are magic in Markdown:
	$_ = str_replace(array_keys($md_escape_table),
					 array_values($md_escape_table), $_);

	return $_;
}


function _DoItalicsAndBold($text) {
	# <strong> must go first:
	$text = preg_replace('{
			(						# $1: Marker
				(?<!\*\*) \*\* |	#     (not preceded by two chars of
				(?<!__)   __		#      the same marker)
			)
			(?=\S) 					# Not followed by whitespace
			(?!\1)					#   or two others marker chars.
			(						# $2: Content
				(?:
					[^*_]+?			# Anthing not em markers.
				|
									# Balence any regular emphasis inside.
					([*_]) (?=\S) .+? (?<=\S) \3	# $3: em char (* or _)
				|
					(?! \1 ) .		# Allow unbalenced * and _.
				)+?
			)
			(?<=\S) \1				# End mark not preceded by whitespace.
		}sx',
		'<strong>\2</strong>', $text);
	# Then <em>:
	$text = preg_replace(
		'{ ( (?<!\*)\* | (?<!_)_ ) (?=\S) (?! \1) (.+?) (?<=\S) \1 }sx',
		'<em>\2</em>', $text);

	return $text;
}


function _DoBlockQuotes($text) {
	$text = preg_replace_callback('/
		  (								# Wrap whole match in $1
			(
			  ^[ \t]*>[ \t]?			# "">"" at the start of a line
				.+\n					# rest of the first line
			  (.+\n)*					# subsequent consecutive lines
			  \n*						# blanks
			)+
		  )
		/xm',
		'_DoBlockQuotes_callback', $text);

	return $text;
}
function _DoBlockQuotes_callback($matches) {
	$bq = $matches[1];
	# trim one level of quoting - trim whitespace-only lines
	$bq = preg_replace(array('/^[ \t]*>[ \t]?/m', '/^[ \t]+$/m'), '', $bq);
	$bq = _RunBlockGamut($bq);		# recurse

	$bq = preg_replace('/^/m', ""  "", $bq);
	# These leading spaces screw with <pre> content, so we need to fix that:
	$bq = preg_replace_callback('{(\s*<pre>.+?</pre>)}sx',
								'_DoBlockQuotes_callback2', $bq);

	return ""<blockquote>\n$bq\n</blockquote>\n\n"";
}
function _DoBlockQuotes_callback2($matches) {
	$pre = $matches[1];
	$pre = preg_replace('/^  /m', '', $pre);
	return $pre;
}


function _FormParagraphs($text) {
#
#	Params:
#		$text - string to process with html <p> tags
#
	global $md_html_blocks;

	# Strip leading and trailing lines:
	$text = preg_replace(array('/\A\n+/', '/\n+\z/'), '', $text);

	$grafs = preg_split('/\n{2,}/', $text, -1, PREG_SPLIT_NO_EMPTY);

	#
	# Wrap <p> tags.
	#
	foreach ($grafs as $key => $value) {
		if (!isset( $md_html_blocks[$value] )) {
			$value = _RunSpanGamut($value);
			$value = preg_replace('/^([ \t]*)/', '<p>', $value);
			$value .= ""</p>"";
			$grafs[$key] = $value;
		}
	}

	#
	# Unhashify HTML blocks
	#
	foreach ($grafs as $key => $value) {
		if (isset( $md_html_blocks[$value] )) {
			$grafs[$key] = $md_html_blocks[$value];
		}
	}

	return implode(""\n\n"", $grafs);
}


function _EncodeAmpsAndAngles($text) {
# Smart processing for ampersands and angle brackets that need to be encoded.

	# Ampersand-encoding based entirely on Nat Irons's Amputator MT plugin:
	#   http://bumppo.net/projects/amputator/
	$text = preg_replace('/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/',
						 '&amp;', $text);;

	# Encode naked <'s
	$text = preg_replace('{<(?![a-z/?\$!])}i', '&lt;', $text);

	return $text;
}


function _EncodeBackslashEscapes($text) {
#
#	Parameter:  String.
#	Returns:    The string, with after processing the following backslash
#				escape sequences.
#
	global $md_escape_table, $md_backslash_escape_table;
	# Must process escaped backslashes first.
	return str_replace(array_keys($md_backslash_escape_table),
					   array_values($md_backslash_escape_table), $text);
}


function _DoAutoLinks($text) {
	$text = preg_replace(""!<((https?|ftp):[^'\"">\\s]+)>!"",
						 '<a href=""\1"">\1</a>', $text);

	# Email addresses: <address@domain.foo>
	$text = preg_replace('{
		<
        (?:mailto:)?
		(
			[-.\w]+
			\@
			[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+
		)
		>
		}exi',
		""_EncodeEmailAddress(_UnescapeSpecialChars(_UnslashQuotes('\\1')))"",
		$text);

	return $text;
}


function _EncodeEmailAddress($addr) {
#
#	Input: an email address, e.g. ""foo@example.com""
#
#	Output: the email address as a mailto link, with each character
#		of the address encoded as either a decimal or hex entity, in
#		the hopes of foiling most address harvesting spam bots. E.g.:
#
#	  <a href=""&#x6D;&#97;&#105;&#108;&#x74;&#111;:&#102;&#111;&#111;&#64;&#101;
#		x&#x61;&#109;&#x70;&#108;&#x65;&#x2E;&#99;&#111;&#109;"">&#102;&#111;&#111;
#		&#64;&#101;x&#x61;&#109;&#x70;&#108;&#x65;&#x2E;&#99;&#111;&#109;</a>
#
#	Based by a filter by Matthew Wickline, posted to the BBEdit-Talk
#	mailing list: <http://tinyurl.com/yu7ue>
#
	$addr = ""mailto:"" . $addr;
	$length = strlen($addr);

	# leave ':' alone (to spot mailto: later)
	$addr = preg_replace_callback('/([^\:])/',
								  '_EncodeEmailAddress_callback', $addr);

	$addr = ""<a href=\""$addr\"">$addr</a>"";
	# strip the mailto: from the visible part
	$addr = preg_replace('/"">.+?:/', '"">', $addr);

	return $addr;
}
function _EncodeEmailAddress_callback($matches) {
	$char = $matches[1];
	$r = rand(0, 100);
	# roughly 10% raw, 45% hex, 45% dec
	# '@' *must* be encoded. I insist.
	if ($r > 90 && $char != '@') return $char;
	if ($r < 45) return '&#x'.dechex(ord($char)).';';
	return '&#'.ord($char).';';
}


function _UnescapeSpecialChars($text) {
#
# Swap back in all the special characters we've hidden.
#
	global $md_escape_table;
	return str_replace(array_values($md_escape_table),
					   array_keys($md_escape_table), $text);
}


# _TokenizeHTML is shared between PHP Markdown and PHP SmartyPants.
# We only define it if it is not already defined.
if (!function_exists('_TokenizeHTML')) :
function _TokenizeHTML($str) {
#
#   Parameter:  String containing HTML markup.
#   Returns:    An array of the tokens comprising the input
#               string. Each token is either a tag (possibly with nested,
#               tags contained therein, such as <a href=""<MTFoo>"">, or a
#               run of text between tags. Each element of the array is a
#               two-element array; the first is either 'tag' or 'text';
#               the second is the actual value.
#
#
#   Regular expression derived from the _tokenize() subroutine in
#   Brad Choate's MTRegex plugin.
#   <http://www.bradchoate.com/past/mtregex.php>
#
	$index = 0;
	$tokens = array();

	$match = '(?s:<!(?:--.*?--\s*)+>)|'.	# comment
			 '(?s:<\?.*?\?>)|'.				# processing instruction
			 								# regular tags
			 '(?:<[/!$]?[-a-zA-Z0-9:]+\b(?>[^""\'>]+|""[^""]*""|\'[^\']*\')*>)';

	$parts = preg_split(""{($match)}"", $str, -1, PREG_SPLIT_DELIM_CAPTURE);

	foreach ($parts as $part) {
		if (++$index % 2 && $part != '')
			$tokens[] = array('text', $part);
		else
			$tokens[] = array('tag', $part);
	}

	return $tokens;
}
endif;


function _Outdent($text) {
#
# Remove one level of line-leading tabs or spaces
#
	global $md_tab_width;
	return preg_replace(""/^(\\t|[ ]{1,$md_tab_width})/m"", """", $text);
}


function _Detab($text) {
#
# Replace tabs with the appropriate amount of space.
#
	global $md_tab_width;

	# For each line we separate the line in blocks delemited by
	# tab characters. Then we reconstruct every line by adding the
	# appropriate number of space between each blocks.

	$lines = explode(""\n"", $text);
	$text = """";

	foreach ($lines as $line) {
		# Split in blocks.
		$blocks = explode(""\t"", $line);
		# Add each blocks to the line.
		$line = $blocks[0];
		unset($blocks[0]); # Do not add first block twice.
		foreach ($blocks as $block) {
			# Calculate amount of space, insert spaces, insert block.
			$amount = $md_tab_width - strlen($line) % $md_tab_width;
			$line .= str_repeat("" "", $amount) . $block;
		}
		$text .= ""$line\n"";
	}
	return $text;
}


function _UnslashQuotes($text) {
#
#	This function is useful to remove automaticaly slashed double quotes
#	when using preg_replace and evaluating an expression.
#	Parameter:  String.
#	Returns:    The string with any slash-double-quote (\"") sequence replaced
#				by a single double quote.
#
	return str_replace('\""', '""', $text);
}


/*

PHP Markdown
============

Description
-----------

This is a PHP translation of the original Markdown formatter written in
Perl by John Gruber.

Markdown is a text-to-HTML filter; it translates an easy-to-read /
easy-to-write structured text format into HTML. Markdown's text format
is most similar to that of plain text email, and supports features such
as headers, *emphasis*, code blocks, blockquotes, and links.

Markdown's syntax is designed not as a generic markup language, but
specifically to serve as a front-end to (X)HTML. You can use span-level
HTML tags anywhere in a Markdown document, and you can use block level
HTML tags (like <div> and <table> as well).

For more information about Markdown's syntax, see:

<http://daringfireball.net/projects/markdown/>


Bugs
----

To file bug reports please send email to:

<michel.fortin@michelf.com>

Please include with your report: (1) the example input; (2) the output you
expected; (3) the output Markdown actually produced.


Version History
---------------

See the readme file for detailed release notes for this version.

1.0.1b - 6 Jun 2005

1.0.1a - 15 Apr 2005

1.0.1 - 16 Dec 2004

1.0 - 21 Aug 2004


Author & Contributors
---------------------

Original Perl version by John Gruber
<http://daringfireball.net/>

PHP port and other contributions by Michel Fortin
<http://www.michelf.com/>


Copyright and License
---------------------

Copyright (c) 2004-2005 Michel Fortin
<http://www.michelf.com/>
All rights reserved.

Copyright (c) 2003-2004 John Gruber
<http://daringfireball.net/>
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*	Redistributions of source code must retain the above copyright notice,
	this list of conditions and the following disclaimer.

*	Redistributions in binary form must reproduce the above copyright
	notice, this list of conditions and the following disclaimer in the
	documentation and/or other materials provided with the distribution.

*	Neither the name ""Markdown"" nor the names of its contributors may
	be used to endorse or promote products derived from this software
	without specific prior written permission.

This software is provided by the copyright holders and contributors ""as
is"" and any express or implied warranties, including, but not limited
to, the implied warranties of merchantability and fitness for a
particular purpose are disclaimed. In no event shall the copyright owner
or contributors be liable for any direct, indirect, incidental, special,
exemplary, or consequential damages (including, but not limited to,
procurement of substitute goods or services; loss of use, data, or
profits; or business interruption) however caused and on any theory of
liability, whether in contract, strict liability, or tort (including
negligence or otherwise) arising in any way out of the use of this
software, even if advised of the possibility of such damage.

*/"
29,1,FF,ff_addCustomCSSFile,Add custom CSS File,"Adds a custom css file to the form. To choose a css file, execute this piece and call the function ff_addCustomCSSFile('path/to/css/file') with the RELATIVE (not full!) path to your joomla installation.
Do not forget to call $this->execPieceByName('ff_InitLib') before!

Example:

global $mainframe;

$this->execPieceByName('ff_InitLib');
$this->execPieceByName('ff_addCustomCSSFile');

ff_addCustomCSSFile('templates/' . $mainframe->getTemplate() . '/css/template.css');",Before Form,"function ff_addCustomCSSFile($path){
	if(file_exists(JPATH_SITE . '/' . $path)){
		JFactory::getDocument()->addStyleSheet(JURI::root() . $path);
	}
}"
30,1,FF,ff_Constants,Constansts definitions,Library constants definitions,Before Form,"define('FF_DIE',       '_ff_die_on_errors_');
define('FF_DONTDIE',   '_ff_stay_alive_');
define('FF_IGNOREDIE', '_ff_ignore_if_dying_');

define('FF_ARRAY',     '_ff_return_as_array_');
define('FF_LIST',      '_ff_return_as_list_');
define('FF_SLIST',     '_ff_return_as_slist_');
define('FF_DLIST',     '_ff_return_as_dlist_');

define('FF_NOTRIM',    1);
define('FF_ALLOWHTML', 2);
define('FF_ALLOWRAW',  4);"
31,1,FF,ff_die,Terminate form gracefully,"Gracefully terminates the form and shows a message plus opionally a 
CONTINUE button for further redirection.

Call:

    ff_die($message=null, $action='stop', $target='', $params='', $label='Continue');
    return;

    $message = A message to display. If no message is provided, it will
               display:

                    Fatal error in $formname, processing stopped.

    $action  = 'stop' : Dont show a CONTINUE button (default)
               'self' : Redirect to the same form
               'form' : Redirect to another form 
               'page' : Redirect to another page of this site
               'home' : Redirect to homepage of the site
               'url'  : Redirect to a url

    $target  = Target name/url for 'form', 'page' and 'url'

    $params  = Additional parameters for 'self' and 'form'

    $label   = Text for the continue button

Examples:

    // Display standard message without continue button
    ff_die(); 

    // Display message without continue button
    ff_die('Sorry, cannot continue for some reason.');

    // Display standard message and return to same form with a parameter
    ff_die(null, 'self', '&ff_param_foo=bar');

    // Redirect to another form
    ff_die('Guess you are hungry now...', 'form', 'SamplePizzaShop', null, 'Order');

    // Redirect to another site page
    ff_die(
        'Something strange has happened!', 
        'page', 
        'index.php?option=com_content&task=section&id=1&Itemid=2'
    );",Untyped,"function ff_die($message='', $action='stop', $target='', $params='', $label='Continue')
{
    global $ff_processor;
    if ($ff_processor->dying) return;

    ob_end_clean();
    $form =& $ff_processor->formrow;
    if (!$message) 
        $message = 
            ""<strong>Fatal error in $form->name, form processing halted.</strong>"";
    switch ($action) {
        case 'self': $url = ff_makeSelfUrl($params); break;
        case 'form': $url = ff_makeFormUrl($target, $params); break;
        case 'page': $url = ff_makePageUrl($target); break;
        case 'home': $url = ""{mossite}""; break;
        case 'url' : $url = $target; break;
        default    : $url = '';
    } // switch
    if ($form->class1 != '') echo '<div class=""'.$form->class1.'"">'.nl();
    echo($message.'<br/><br/><br/>'.nl());
    if ($url) {
        if (!$ff_processor->inline) echo '<form action=""#redirect"">'.nl();
        if ($ff_processor->inframe) $t = 'parent'; else $t = 'document';
        echo '<input type=""button"" class=""button"" value=""'.$label.'""'.
             ' onClick=""'.$t.'.location.href=\''.htmlentities($url,ENT_QUOTES).'\';""'.
             '/>'.nl();
        if (!$ff_processor->inline) echo '</form>'.nl();
    } // if
    if ($form->class1 != '') echo '</div>'.nl();
    unset($form);
    ob_start();
    $ff_processor->suicide();
} // ff_die"
32,1,FF,ff_DisableFormTrace,Disable tracing at view time,Disables tracing for use as before form piece,Before Form,//+trace dis
33,1,FF,ff_DisableSubmitTrace,Disable tracing at submit time,Disables tracing for use as begin submit piece,Begin Submit,//+trace dis
34,1,FF,ff_dying,Query live status,Query if form is dying,Untyped,"//+trace max none
function ff_dying()
{
    global $ff_processor; 
    return $ff_processor->dying;
} // ff_dying"
35,1,FF,ff_expString,String export,Export string function: escapes special characters in c-codes,Untyped,"function ff_expString($text)
{
    return expstring($text);
} // ff_expString"
36,1,FF,ff_getPageByNameX,Get page # by element name,"Gets the page number by the name of an element. 
Typically used to redirect to a certain page in a before form piece 
as 

    $this->page = ff_getPageByName('elementname');",Untyped,"function ff_getPageByName($name)
{
    global $ff_processor;
    foreach($ff_processor->rows as $row)
        if ($row->name==$name)
            return $row->page;
    return null;
} // ff_getPageByName"
37,1,FF,ff_getParam,Get GET/POST parameter,"Direct replacement for mosGetParam. ff_getParam will attempt to filter 
out parameters that are targeted to another form on the same page.",Untyped,"function ff_getParam($name, $default=null, $mask=0)
{
    global $ff_request;
    if (substr($name,0,9)=='ff_param_') {
        if (!isset($ff_request[$name])) return $default;
        $val = $ff_request[$name];
    } else {
        if (!isset($_REQUEST[$name])) return $default;
        $val = $_REQUEST[$name];
    } // if
    $dotrim = ($mask & FF_NOTRIM)==0;
    $dostrp = ($mask & FF_ALLOWHTML)==0;
    $addsla = ($mask & FF_ALLOWRAW)==0 && !get_magic_quotes_gpc();
    $remsla = ($mask & FF_ALLOWRAW)!=0 && get_magic_quotes_gpc();
    if (is_array($val)) {
        $cnt = count($val);
        for ($v = 0; $v < $cnt; $v++)
            if (is_string($val[$v])) {
                if ($dotrim) $val[$v] = trim($val[$v]);
                if ($dostrp) $val[$v] = strip_tags($val[$v]);
                if ($addsla) $val[$v] = addslashes($val[$v]);
                if ($remsla) $val[$v] = stripslashes($val[$v]);
            } // if
    } else {
        if (is_string($val)) {
            if ($dotrim) $val = trim($val);
            if ($dostrp) $val = strip_tags($val);
            if ($addsla) $val = addslashes($val);
            if ($remsla) $val = stripslashes($val);
        } // if
    } // if
    return $val;
} // ff_getParam"
38,1,FF,ff_getSubmit,Get submited data,"Returns submitdata either as scalar, array or list. In case of list the values
are returned as a string with the values concatenated by comma.

Examples:

// Get as scalar: Optionally pass a default value as second parameter.
// If no default is provided, it will return NULL if no value was submitted

    $myval = ff_getSubmit('myvar');        // return NULL if not submitted

    $myval = ff_getSubmit('myvar',1);      // return 1 if not submitted

    $myval = ff_getSubmit('myvar','foo');  // return 'foo' if not submitted

    ff_query(
        ""insert into #__mytable(id, name) "".
        ""values ('"".
            ff_getSubmit('id')."", "".
            ff_getSubmit('name','unknown').
        ""')""
    );

// Get as array: Pass FF_ARRAY as second Parameter

    $myarr = $ff_getSubmit('myarr', FF_ARRAY);

    foreach ($myarr as $myval) ...

// Get as list: Pass either FF_LIST, FF_SLIST or FF_DLIST as 2nd parameter.

    // FF_LIST will return numeric data unquoted and strings in single quotes:
    //    1,2,'a',4

    // FF_SLIST will return all data single quoted:
    //    '1','2','a','4'

    // FF_DLIST will return all data double quoted:
    //    ""1"",""2"",""a"",""4""

    ff_query(
        ""delete from #__mytable "".
        ""where id in ("".ff_getSubmit('itemlist',FF_LIST)."")""
    );",Untyped,"function ff_getSubmit($name, $default=null)
{
    global $ff_processor;

    switch ((string)$default) {
        case FF_ARRAY: $value = array(); break;
        case FF_LIST : 
        case FF_SLIST:
        case FF_DLIST: $value = ''; break;
        default      : $value = $default;
    } // switch
    foreach ($ff_processor->submitdata as $data)
        if ($data[_FF_DATA_NAME]==$name) {
            $q = '';
            switch ((string)$default) {
                case FF_ARRAY:
                    $value[] = $data[_FF_DATA_VALUE];
                    break;
                case FF_SLIST:
                    $q = ""'"";
                case FF_DLIST:
                    if ($q=='') $q = '""';
                case FF_LIST:
                    if ($q=='' && !is_numeric($data[_FF_DATA_VALUE])) $q = ""'"";
                    if ($value!='') $value.=',';
                    $value .= $q.$data[_FF_DATA_VALUE].$q;
                    break;
                default:
                    return $data[_FF_DATA_VALUE];
            } // switch
         } // if
    return $value;
} // ff_getSubmit"
39,1,FF,ff_impString,String import,Import string function: unescapes c-coded characters of a string,Untyped,"function ff_impString($text)
{
    return impstring($text);
} // ff_impString"
40,1,FF,ff_InitLib,Init Library,"A collection of useful functions for use in form pieces. 

Include by: 

    $this->execPieceByName('ff_InitLib');",Before Form,"//+trace high none
if (!defined('FF_DIE'))                    $this->execPieceByName('ff_Constants');
if (!function_exists('ff_expstring'))      $this->execPieceByName('ff_expstring');
if (!function_exists('ff_makePageUrl'))    $this->execPieceByName('ff_makePageUrl');
if (!function_exists('ff_makeFormUrl'))    $this->execPieceByName('ff_makeFormUrl');
if (!function_exists('ff_makeSelfUrl'))    $this->execPieceByName('ff_makeSelfUrl');
if (!function_exists('ff_die'))            $this->execPieceByName('ff_die');
if (!function_exists('ff_dying'))          $this->execPieceByName('ff_dying');
if (!function_exists('ff_redirect'))       $this->execPieceByName('ff_redirect');
if (!function_exists('ff_redirectParent')) $this->execPieceByName('ff_redirectParentX');
if (!function_exists('ff_redirectPage'))   $this->execPieceByName('ff_redirectPage');
if (!function_exists('ff_redirectForm'))   $this->execPieceByName('ff_redirectForm');
if (!function_exists('ff_redirectSelf'))   $this->execPieceByName('ff_redirectSelf');
if (!function_exists('ff_setChecked'))     $this->execPieceByName('ff_setCheckedX');
if (!function_exists('ff_setSelected'))    $this->execPieceByName('ff_setSelectedX');
if (!function_exists('ff_setValue'))       $this->execPieceByName('ff_setValueX');
if (!function_exists('ff_getPageByName'))  $this->execPieceByName('ff_getPageByNameX');
if (!function_exists('ff_getParam'))       $this->execPieceByName('ff_getParam');
if (!function_exists('ff_getSubmit'))      $this->execPieceByName('ff_getSubmit');
if (!function_exists('ff_impString'))      $this->execPieceByName('ff_impString');
if (!function_exists('ff_expString'))      $this->execPieceByName('ff_expString');
if (!function_exists('ff_securityImage'))  $this->execPieceByName('ff_securityImage');
if (!function_exists('ff_select'))         $this->execPieceByName('ff_select');
if (!function_exists('ff_selectValue'))    $this->execPieceByName('ff_selectValue');
if (!function_exists('ff_query'))          $this->execPieceByName('ff_query');
if (!function_exists('ff_markdown'))       $this->execPieceByName('ff_markdown');"
41,1,FF,ff_makeFormUrl,Make URL to other form,"Redirects to another facile form. 

Call: 

    $url = ff_makeFormUrl($name, $params = '');

Example:

    $url = ff_makeFormUrl(
       'OtherForm', 
       '&ff_param_email='.urlencode($email)
    );",Untyped,"function ff_makeFormUrl($name, $params='')
{
    global $ff_processor, $ff_otherparams;
    $url = '';
    switch ($ff_processor->runmode) {
        case 2: // preview
        case 1: // backend
            $url .= 'administrator/index2.php?option=com_breezingforms&act=run'.
                    '&ff_name='.urlencode($name);
            if ($ff_processor->inframe) $url .= '&ff_frame=1';
            if ($ff_processor->border) $url .= '&ff_border=1';
            break;
        default: // frontend
            $url .= 'index.php?ff_name='.urlencode($name);
            if ($ff_otherparams['option'] == 'com_breezingforms') {
                reset($ff_otherparams);
                while (list($prop, $val) = each($ff_otherparams))
                    $url .= '&'.urlencode($prop).'='.urlencode($val);
            } else
                $url .= '&option=com_breezingforms';
            if ($ff_processor->target > 1) $url .= '&ff_target='.$ff_processor->target;
            if ($ff_processor->inframe) $url .= '&ff_frame=1';
            if ($ff_processor->border) $url .= '&ff_border=1';
            if ($ff_processor->align !=1) $url .= '&ff_align='.$ff_processor->align;
            if ($ff_processor->top>0) $url .= '&ff_top='.$ff_processor->top;
    } // switch
    return ff_makePageUrl($url. $params);
} // ff_makeFormUrl"
42,1,FF,ff_makePageUrl,Make URL to other page,"Builds an URL to another mambo page

Call: 

    $url = ff_makePageUrl($params = '');

Example:

    $url = ff_makePageUrl(
        'index.php?option=com_content&task=blogsection&id=0&Itemid=39'
    );",Untyped,"function ff_makePageUrl($params='')
{
    $url = '{mossite}';
    if ($params != '') {
        $len = strlen($url);
        if ($len > 0 && $url{$len-1} != '/') $url .= '/';
        $url .= $params;
    } // if
    return $url;
} // ff_makePageUrl"
43,1,FF,ff_makeSelfUrl,Make URL to same form,"Make an URL to the same form. 

Call: 

    $url = ff_makeSelfUrl($params = '');

Example:

    $url = ff_makeSelfUrl('&ff_param_email='.urlencode($email));",Untyped,"function ff_makeSelfUrl($params='')
{
    global $ff_processor;
    return ff_makeFormUrl($ff_processor->formrow->name, $params);
} // ff_makeSelfUrl"
44,1,FF,ff_query,Non-select queries against db,"Execute a simple db query.

Include by one of:

    $this->execPieceByName('ff_InitUtilities');
    $this->execPieceByName('ff_SubmitUtilities');
    if (!function_exists('ff_query')) $this->execPieceByName('ff_query');

Call syntax:

    [$newid = ] ff_query($sql [, $insert = 0]);

    $sql:    Sql statement to call
    $insert: 1 = return key of auto column when inserting rows
    $newid:  The key of the new row.",Untyped,"function ff_query($sql, $insert=false, $error=FF_DIE)
{
    global $ff_processor;
    $database = JFactory::getDBO();
    if ($ff_processor->dying && $error!=FF_IGNOREDIE) return -1;
    $database->setQuery($sql);
    $database->query();
    if ($database->getErrorNum()) {
        $dienow = $error==FF_DIE;
        $error = $database->stderr();
        if ($dienow) ff_die($error);
    } else {
        $error = null;
        if ($insert) return $database->insertid();
    } // if
    return 0;
} // ff_query"
45,1,FF,ff_redirect,Basic redirection,"Basic redirection routine supporting multiple targets and methods.

Call:
 
ff_redirect($url [, $target='self' , $method='post'])

    $url    = The url to redirect to including the parameters appended.

    $target = 'top', 'parent', 'self' or 'blank'

              'top'    = redirect to the top browser window
              'parent' = redirect to the parent frame
              'self'   = redirect in the same frame (the default)
              'blank'  = redirect to a new browser window 
                         (blank works with post method only)

    $method = 'post' or 'get'. The default is 'post'.

    Example:

       ff_redirect(
          'http://mysite.net/index.php?option=xxx&Itemid=33',
          'top'
       );",Untyped,"function ff_redirect($url, $target='self', $method='post')
{
    global $ff_processor, $ff_request;
    if ($ff_processor->dying) return;

    ob_end_clean();
    switch (strtolower($method)) {
        case 'get': {
            switch (strtolower($target)) {
                case 'top'   :
                case 'parent': break;
                default      : $target = 'document';
            } // switch
            echo '<script type=""text/javascript"">'.nl().
                 '<!--'.nl().
                 ""onload=function() { "".$target."".location.href='"".$url.""'; }"".nl().
                 '-->'.nl().
                 '</script>'.nl().
                 '</body>'.nl();
            break;
        } // url
        default: { // post
            $pos = strpos($url,'?');
            $ff_request = array();
            if ($pos === false)
                $action = $url;
            else {
                $action = substr($url,0,$pos);
                addRequestParams(substr($url, $pos+1));
            } // if
            switch (strtolower($target)) {
                case 'blank' : $target = ' target=""_blank""';  break;
                case 'top'   : $target = ' target=""_top""';    break;
                case 'parent': $target = ' target=""_parent""'; break;
                default      : $target = ' target=""_self""';
            } // switch
            echo '<script language=""javascript"" type=""text/javascript"">'.nl().
                 '<!--'.nl().
                 'onload = function() { document.ff_redirect.submit(); }'.nl().
                 '-->'.nl().
                 '</script>'.nl().
                 '<form action=""'.$action.'"" '.
                  'method=""post"" '.
                  'name=""ff_redirect"" id=""ff_redirect"" '.
                  'enctype=""multipart/form-data""'.
                  $target.
                 '>'.nl();
            while (list($prop, $val) = each($ff_request))
                echo '<input type=""hidden"" name=""'.$prop.'"" '.
                            'value=""'.htmlentities(urldecode($val)).'""/>'.nl();
            echo '</form>'.nl().
                 '</body>'.nl();
        } // post
    } // switch
    exit;
} // ff_redirect"
46,1,FF,ff_redirectForm,Redirect to other form,"Redirects to another facile form. 

Call: 

    ff_redirectForm($name, $params = '');

Example:

    ff_redirectForm(
        $this, 
       'SecondForm', 
       '&ff_param_email='.urlencode($email)
    );",Untyped,"function ff_redirectForm($name, $params='', $method='post')
{
    ff_redirectParent(ff_makeFormUrl($name, $params), $method);
} // ff_redirectForm"
47,1,FF,ff_redirectPage,Redirect to other page,"Redirects to another mambo page. 

Call: 

    ff_redirectPage($params = '');

Example:

    ff_redirectPage(
        'index.php?option=com_content&task=blogsection&id=0&Itemid=39'
    );",Untyped,"function ff_redirectPage($params='', $method='post')
{
    ff_redirectParent(ff_makePageUrl($params), $method);
} // ff_redirectPage"
48,1,FF,ff_redirectParentX,Redirect to parent window,"Redirects to the parent window when runing in iframe, otherwise to self. 

ff_redirectParent($url [, $method='post'])

    $url    = The url to redirect to including the parameters appended.

    $method = 'post' or 'url'. The default is 'post'.

    Example:

       ff_redirectParent(
          'http://mysite.net/index.php?option=xxx&Itemid=33',
          'url'
       );",Untyped,"function ff_redirectParent($url, $method = 'post')
{
    global $ff_processor;
    if ($ff_processor->inframe) $target = 'parent'; else $target = 'self'; 
    ff_redirect($url, $target, $method);
} // ff_redirectParent"
49,1,FF,ff_redirectSelf,Redirect to same form,"Redirects to the same form. 

Call: 

    ff_redirectSelf($params = '');

Example:

    ff_redirectSelf('&ff_param_email='.urlencode($email));",Untyped,"function ff_redirectSelf($params='', $method='post')
{
    ff_redirectParent(ff_makeSelfUrl($params), $method);
} // ff_redirectSelf"
50,1,FF,ff_securityImage,Security Image,Create code to display the security image,Untyped,"global $ff_seccode;

if (!isset($this->record_id)) { $ff_seccode = null; }

function ff_securityImage()
{
    global $ff_comsite, $ff_seccode;
    if (!isset($ff_seccode)) { 
        mt_srand((double)microtime()*1000000);
        $ff_seccode = mt_rand(10000, 99999);
        JFactory::getSession()->set('ff_seccode', $ff_seccode);
    } // if

    return '<img src=""'.JURI::root().'ff_secimage.php?option=com_breezingforms&showSecImage=true"" title="""" alt="""" />';
} // ff_securityImage"
51,1,FF,ff_select,Select rows from db,"Execute a select query

Include by one of:

    $this->execPieceByName('ff_InitUtilities');
    $this->execPieceByName('ff_SubmitUtilities');
    if (!function_exists('ff_select')) $this->execPieceByName('ff_select');

Call syntax:

    $rows = ff_select($sql);

    $sql:    Sql SELECT-statement to call
    $rows:   List of row objects",Untyped,"function ff_select($sql, $error=FF_DIE)
{
    $database = JFactory::getDBO();
    $database->setQuery($sql);
    $rows = $database->loadObjectList();
    if ($database->getErrorNum()) {
        $dienow = $error==FF_DIE;
        $error = $database->stderr();
        $rows = array();
        if ($dienow) ff_die($error);
    } else
        $error = null;
    return $rows;
} // ff_select"
52,1,FF,ff_selectValue,Select single value from db,"Execute query to read a single value

Include by one of:

    $this->execPieceByName('ff_InitUtilities');
    $this->execPieceByName('ff_SubmitUtilities');
    if (!function_exists('ff_selectValue')) $this->execPieceByName('ff_selectValue');

Call syntax:

    $value = ff_selectValue($sql);

    $sql:    Sql SELECT-statement to call
    $value:  The value returned by the database",Untyped,"function ff_selectValue($sql, $def=null, $error=FF_DIE)
{
    $database = JFactory::getDBO();
    $database->setQuery($sql);
    $value = $database->loadResult();
    if ($database->getErrorNum()) {
        $dienow = $error==FF_DIE;
        $error = $database->stderr();
        if ($dienow) ff_die($error);
    } else {
        $error = null;
        if ($value) return $value;
    } // if
    return $def;
} // ff_selectValue"
53,1,FF,ff_setCheckedX,Set checkbox/radiobutton checked,"Set a radio button or checkbox checked. 

Call: 

    ff_setChecked('name', 'value');",Untyped,"function ff_setChecked($name, $value)
{
    global $ff_processor;
    for ($r = 0; $r < $ff_processor->rowcount; $r++) {
        $row =& $ff_processor->rows[$r];
        if ($row->name==$name && $row->data1==$value)
            $row->flag1 = 1;
        unset($row);
    } // for
} // ff_setChecked"
54,1,FF,ff_setSelectedX,Set a select list option to *selected*,"Sets a select list option to selected. 

Call: 

    ff_setSelected('name', 'value');",Untyped,"function ff_setSelected($name, $value)
{
    global $ff_processor;
    for ($r = 0; $r < $ff_processor->rowcount; $r++) {
        $row =& $ff_processor->rows[$r];
        if ($row->name==$name)
            $row->data2 =
                preg_replace(
                    '/(^|\r\n|\n)(0|1);([^;]*);('.$value.')($|\r\n|\n)/',
                    '${1}1;${3};${4}${5}',
                    $row->data2
                );
        unset($row);
    } // for
} // ff_setSelected"
55,1,FF,ff_setValueX,"Set text, textarea, hidden value","Set value of a Static Text, Text, Textarea or Hidden Input. 

Call: 

    ff_setValue('name', 'value');",Untyped,"function ff_setValue($name, $value)
{
    global $ff_processor;
    for ($r = 0; $r < $ff_processor->rowcount; $r++) {
        $row =& $ff_processor->rows[$r];
        if ($row->name==$name)
            $row->data1 = $value;
        unset($row);
    } // for
} // ff_setValue"
56,1,FF,Markdown,Original Markdown Processor,"Converts text marked up by 'Markdown' into HTML.

Please use ff_markdown() in forms instead of Markdown()",Untyped,"#
# Markdown  -  A text-to-HTML conversion tool for web writers
#
# Copyright (c) 2004-2005 John Gruber
# <http://daringfireball.net/projects/markdown/>
#
# Copyright (c) 2004-2005 Michel Fortin - PHP Port
# <http://www.michelf.com/projects/php-markdown/>
#

global	$MarkdownPHPVersion, $MarkdownSyntaxVersion,
		$md_empty_element_suffix, $md_tab_width,
		$md_nested_brackets_depth, $md_nested_brackets,
		$md_escape_table, $md_backslash_escape_table,
		$md_list_level;

$MarkdownPHPVersion    = '1.0.1b'; # Mon 6 Jun 2005
$MarkdownSyntaxVersion = '1.0.1';  # Sun 12 Dec 2004


#
# Global default settings:
#
$md_empty_element_suffix = "" />"";     # Change to "">"" for HTML output
$md_tab_width = 4;

#
# WordPress settings:
#
$md_wp_posts    = true;  # Set to false to remove Markdown from posts.
$md_wp_comments = true;  # Set to false to remove Markdown from comments.


# -- WordPress Plugin Interface -----------------------------------------------
/*
Plugin Name: Markdown
Plugin URI: http://www.michelf.com/projects/php-markdown/
Description: <a href=""http://daringfireball.net/projects/markdown/syntax"">Markdown syntax</a> allows you to write using an easy-to-read, easy-to-write plain text format. Based on the original Perl version by <a href=""http://daringfireball.net/"">John Gruber</a>. <a href=""http://www.michelf.com/projects/php-markdown/"">More...</a>
Version: 1.0.1b
Author: Michel Fortin
Author URI: http://www.michelf.com/
*/
if (isset($wp_version)) {
	# More details about how it works here:
	# <http://www.michelf.com/weblog/2005/wordpress-text-flow-vs-markdown/>

	# Post content and excerpts
	if ($md_wp_posts) {
		remove_filter('the_content',  'wpautop');
		remove_filter('the_excerpt',  'wpautop');
		add_filter('the_content',     'Markdown', 6);
		add_filter('get_the_excerpt', 'Markdown', 6);
		add_filter('get_the_excerpt', 'trim', 7);
		add_filter('the_excerpt',     'md_add_p');
		add_filter('the_excerpt_rss', 'md_strip_p');

		remove_filter('content_save_pre',  'balanceTags', 50);
		remove_filter('excerpt_save_pre',  'balanceTags', 50);
		add_filter('the_content',  	  'balanceTags', 50);
		add_filter('get_the_excerpt', 'balanceTags', 9);

		function md_add_p($text) {
			if (strlen($text) == 0) return;
			if (strcasecmp(substr($text, -3), '<p>') == 0) return $text;
			return '<p>'.$text.'</p>';
		}
		function md_strip_p($t) { return preg_replace('{</?[pP]>}', '', $t); }
	}

	# Comments
	if ($md_wp_comments) {
		remove_filter('comment_text', 'wpautop');
		remove_filter('comment_text', 'make_clickable');
		add_filter('pre_comment_content', 'Markdown', 6);
		add_filter('pre_comment_content', 'md_hide_tags', 8);
		add_filter('pre_comment_content', 'md_show_tags', 12);
		add_filter('get_comment_text',    'Markdown', 6);
		add_filter('get_comment_excerpt', 'Markdown', 6);
		add_filter('get_comment_excerpt', 'md_strip_p', 7);

		global $md_hidden_tags;
		$md_hidden_tags = array(
			'<p>'	=> md5('<p>'),		'</p>'	=> md5('</p>'),
			'<pre>'	=> md5('<pre>'),	'</pre>'=> md5('</pre>'),
			'<ol>'	=> md5('<ol>'),		'</ol>'	=> md5('</ol>'),
			'<ul>'	=> md5('<ul>'),		'</ul>'	=> md5('</ul>'),
			'<li>'	=> md5('<li>'),		'</li>'	=> md5('</li>'),
			);

		function md_hide_tags($text) {
			global $md_hidden_tags;
			return str_replace(array_keys($md_hidden_tags),
								array_values($md_hidden_tags), $text);
		}
		function md_show_tags($text) {
			global $md_hidden_tags;
			return str_replace(array_values($md_hidden_tags),
								array_keys($md_hidden_tags), $text);
		}
	}
}


# -- bBlog Plugin Info --------------------------------------------------------
function identify_modifier_markdown() {
	global $MarkdownPHPVersion;
	return array(
		'name'			=> 'markdown',
		'type'			=> 'modifier',
		'nicename'		=> 'Markdown',
		'description'	=> 'A text-to-HTML conversion tool for web writers',
		'authors'		=> 'Michel Fortin and John Gruber',
		'licence'		=> 'GPL',
		'version'		=> $MarkdownPHPVersion,
		'help'			=> '<a href=""http://daringfireball.net/projects/markdown/syntax"">Markdown syntax</a> allows you to write using an easy-to-read, easy-to-write plain text format. Based on the original Perl version by <a href=""http://daringfireball.net/"">John Gruber</a>. <a href=""http://www.michelf.com/projects/php-markdown/"">More...</a>'
	);
}

# -- Smarty Modifier Interface ------------------------------------------------
function smarty_modifier_markdown($text) {
	return Markdown($text);
}

# -- Textile Compatibility Mode -----------------------------------------------
# Rename this file to ""classTextile.php"" and it can replace Textile anywhere.
if (strcasecmp(substr(__FILE__, -16), ""classTextile.php"") == 0) {
	# Try to include PHP SmartyPants. Should be in the same directory.
	@include_once 'smartypants.php';
	# Fake Textile class. It calls Markdown instead.
	class Textile {
		function TextileThis($text, $lite='', $encode='', $noimage='', $strict='') {
			if ($lite == '' && $encode == '')   $text = Markdown($text);
			if (function_exists('SmartyPants')) $text = SmartyPants($text);
			return $text;
		}
	}
}



#
# Globals:
#

# Regex to match balanced [brackets].
# Needed to insert a maximum bracked depth while converting to PHP.
$md_nested_brackets_depth = 6;
$md_nested_brackets =
	str_repeat('(?>[^\[\]]+|\[', $md_nested_brackets_depth).
	str_repeat('\])*', $md_nested_brackets_depth);

# Table of hash values for escaped characters:
$md_escape_table = array(
	""\\"" => md5(""\\""),
	""`"" => md5(""`""),
	""*"" => md5(""*""),
	""_"" => md5(""_""),
	""{"" => md5(""{""),
	""}"" => md5(""}""),
	""["" => md5(""[""),
	""]"" => md5(""]""),
	""("" => md5(""(""),
	"")"" => md5("")""),
	"">"" => md5("">""),
	""#"" => md5(""#""),
	""+"" => md5(""+""),
	""-"" => md5(""-""),
	""."" => md5("".""),
	""!"" => md5(""!"")
);
# Create an identical table but for escaped characters.
$md_backslash_escape_table;
foreach ($md_escape_table as $key => $char)
	$md_backslash_escape_table[""\\$key""] = $char;


function Markdown($text) {
#
# Main function. The order in which other subs are called here is
# essential. Link and image substitutions need to happen before
# _EscapeSpecialCharsWithinTagAttributes(), so that any *'s or _'s in the <a>
# and <img> tags get encoded.
#
	# Clear the global hashes. If we don't clear these, you get conflicts
	# from other articles when generating a page which contains more than
	# one article (e.g. an index page that shows the N most recent
	# articles):
	global $md_urls, $md_titles, $md_html_blocks;
	$md_urls = array();
	$md_titles = array();
	$md_html_blocks = array();

	# Standardize line endings:
	#   DOS to Unix and Mac to Unix
	$text = str_replace(array(""\r\n"", ""\r""), ""\n"", $text);

	# Make sure $text ends with a couple of newlines:
	$text .= ""\n\n"";

	# Convert all tabs to spaces.
	$text = _Detab($text);

	# Strip any lines consisting only of spaces and tabs.
	# This makes subsequent regexen easier to write, because we can
	# match consecutive blank lines with /\n+/ instead of something
	# contorted like /[ \t]*\n+/ .
	$text = preg_replace('/^[ \t]+$/m', '', $text);

	# Turn block-level HTML blocks into hash entries
	$text = _HashHTMLBlocks($text);

	# Strip link definitions, store in hashes.
	$text = _StripLinkDefinitions($text);

	$text = _RunBlockGamut($text);

	$text = _UnescapeSpecialChars($text);

	return $text . ""\n"";
}


function _StripLinkDefinitions($text) {
#
# Strips link definitions from text, stores the URLs and titles in
# hash references.
#
	global $md_tab_width;
	$less_than_tab = $md_tab_width - 1;

	# Link defs are in the form: ^[id]: url ""optional title""
	$text = preg_replace_callback('{
						^[ ]{0,'.$less_than_tab.'}\[(.+)\]:	# id = $1
						  [ \t]*
						  \n?				# maybe *one* newline
						  [ \t]*
						<?(\S+?)>?			# url = $2
						  [ \t]*
						  \n?				# maybe one newline
						  [ \t]*
						(?:
							(?<=\s)			# lookbehind for whitespace
							[""(]
							(.+?)			# title = $3
							["")]
							[ \t]*
						)?	# title is optional
						(?:\n+|\Z)
		}xm',
		'_StripLinkDefinitions_callback',
		$text);
	return $text;
}
function _StripLinkDefinitions_callback($matches) {
	global $md_urls, $md_titles;
	$link_id = strtolower($matches[1]);
	$md_urls[$link_id] = _EncodeAmpsAndAngles($matches[2]);
	if (isset($matches[3]))
		$md_titles[$link_id] = str_replace('""', '&quot;', $matches[3]);
	return ''; # String that will replace the block
}


function _HashHTMLBlocks($text) {
	global $md_tab_width;
	$less_than_tab = $md_tab_width - 1;

	# Hashify HTML blocks:
	# We only want to do this for block-level HTML tags, such as headers,
	# lists, and tables. That's because we still want to wrap <p>s around
	# ""paragraphs"" that are wrapped in non-block-level tags, such as anchors,
	# phrase emphasis, and spans. The list of tags we're looking for is
	# hard-coded:
	$block_tags_a = 'p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|'.
					'script|noscript|form|fieldset|iframe|math|ins|del';
	$block_tags_b = 'p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|'.
					'script|noscript|form|fieldset|iframe|math';

	# First, look for nested blocks, e.g.:
	# 	<div>
	# 		<div>
	# 		tags for inner block must be indented.
	# 		</div>
	# 	</div>
	#
	# The outermost tags must start at the left margin for this to match, and
	# the inner nested divs must be indented.
	# We need to do this before the next, more liberal match, because the next
	# match will start at the first `<div>` and stop at the first `</div>`.
	$text = preg_replace_callback(""{
				(						# save in $1
					^					# start of line  (with /m)
					<($block_tags_a)	# start tag = $2
					\\b					# word break
					(.*\\n)*?			# any number of lines, minimally matching
					</\\2>				# the matching end tag
					[ \\t]*				# trailing spaces/tabs
					(?=\\n+|\\Z)	# followed by a newline or end of document
				)
		}xm"",
		'_HashHTMLBlocks_callback',
		$text);

	#
	# Now match more liberally, simply from `\n<tag>` to `</tag>\n`
	#
	$text = preg_replace_callback(""{
				(						# save in $1
					^					# start of line  (with /m)
					<($block_tags_b)	# start tag = $2
					\\b					# word break
					(.*\\n)*?			# any number of lines, minimally matching
					.*</\\2>				# the matching end tag
					[ \\t]*				# trailing spaces/tabs
					(?=\\n+|\\Z)	# followed by a newline or end of document
				)
		}xm"",
		'_HashHTMLBlocks_callback',
		$text);

	# Special case just for <hr />. It was easier to make a special case than
	# to make the other regex more complicated.
	$text = preg_replace_callback('{
				(?:
					(?<=\n\n)		# Starting after a blank line
					|				# or
					\A\n?			# the beginning of the doc
				)
				(						# save in $1
					[ ]{0,'.$less_than_tab.'}
					<(hr)				# start tag = $2
					\b					# word break
					([^<>])*?			#
					/?>					# the matching end tag
					[ \t]*
					(?=\n{2,}|\Z)		# followed by a blank line or end of document
				)
		}x',
		'_HashHTMLBlocks_callback',
		$text);

	# Special case for standalone HTML comments:
	$text = preg_replace_callback('{
				(?:
					(?<=\n\n)		# Starting after a blank line
					|				# or
					\A\n?			# the beginning of the doc
				)
				(						# save in $1
					[ ]{0,'.$less_than_tab.'}
					(?s:
						<!
						(--.*?--\s*)+
						>
					)
					[ \t]*
					(?=\n{2,}|\Z)		# followed by a blank line or end of document
				)
			}x',
			'_HashHTMLBlocks_callback',
			$text);

	return $text;
}
function _HashHTMLBlocks_callback($matches) {
	global $md_html_blocks;
	$text = $matches[1];
	$key = md5($text);
	$md_html_blocks[$key] = $text;
	return ""\n\n$key\n\n""; # String that will replace the block
}


function _RunBlockGamut($text) {
#
# These are all the transformations that form block-level
# tags like paragraphs, headers, and list items.
#
	global $md_empty_element_suffix;

	$text = _DoHeaders($text);

	# Do Horizontal Rules:
	$text = preg_replace(
		array('{^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$}mx',
			  '{^[ ]{0,2}([ ]? -[ ]?){3,}[ \t]*$}mx',
			  '{^[ ]{0,2}([ ]? _[ ]?){3,}[ \t]*$}mx'),
		""\n<hr$md_empty_element_suffix\n"",
		$text);

	$text = _DoLists($text);
	$text = _DoCodeBlocks($text);
	$text = _DoBlockQuotes($text);

	# We already ran _HashHTMLBlocks() before, in Markdown(), but that
	# was to escape raw HTML in the original Markdown source. This time,
	# we're escaping the markup we've just created, so that we don't wrap
	# <p> tags around block-level tags.
	$text = _HashHTMLBlocks($text);
	$text = _FormParagraphs($text);

	return $text;
}


function _RunSpanGamut($text) {
#
# These are all the transformations that occur *within* block-level
# tags like paragraphs, headers, and list items.
#
	global $md_empty_element_suffix;

	$text = _DoCodeSpans($text);

	$text = _EscapeSpecialChars($text);

	# Process anchor and image tags. Images must come first,
	# because ![foo][f] looks like an anchor.
	$text = _DoImages($text);
	$text = _DoAnchors($text);

	# Make links out of things like `<http://example.com/>`
	# Must come after _DoAnchors(), because you can use < and >
	# delimiters in inline links like [this](<url>).
	$text = _DoAutoLinks($text);
	$text = _EncodeAmpsAndAngles($text);
	$text = _DoItalicsAndBold($text);

	# Do hard breaks:
	$text = preg_replace('/ {2,}\n/', ""<br$md_empty_element_suffix\n"", $text);

	return $text;
}


function _EscapeSpecialChars($text) {
	global $md_escape_table;
	$tokens = _TokenizeHTML($text);

	$text = '';   # rebuild $text from the tokens
#	$in_pre = 0;  # Keep track of when we're inside <pre> or <code> tags.
#	$tags_to_skip = ""!<(/?)(?:pre|code|kbd|script|math)[\s>]!"";

	foreach ($tokens as $cur_token) {
		if ($cur_token[0] == 'tag') {
			# Within tags, encode * and _ so they don't conflict
			# with their use in Markdown for italics and strong.
			# We're replacing each such character with its
			# corresponding MD5 checksum value; this is likely
			# overkill, but it should prevent us from colliding
			# with the escape values by accident.
			$cur_token[1] = str_replace(array('*', '_'),
				array($md_escape_table['*'], $md_escape_table['_']),
				$cur_token[1]);
			$text .= $cur_token[1];
		} else {
			$t = $cur_token[1];
			$t = _EncodeBackslashEscapes($t);
			$text .= $t;
		}
	}
	return $text;
}


function _DoAnchors($text) {
#
# Turn Markdown link shortcuts into XHTML <a> tags.
#
	global $md_nested_brackets;
	#
	# First, handle reference-style links: [link text] [id]
	#
	$text = preg_replace_callback(""{
		(					# wrap whole match in $1
		  \\[
			($md_nested_brackets)	# link text = $2
		  \\]

		  [ ]?				# one optional space
		  (?:\\n[ ]*)?		# one optional newline followed by spaces

		  \\[
			(.*?)		# id = $3
		  \\]
		)
		}xs"",
		'_DoAnchors_reference_callback', $text);

	#
	# Next, inline-style links: [link text](url ""optional title"")
	#
	$text = preg_replace_callback(""{
		(				# wrap whole match in $1
		  \\[
			($md_nested_brackets)	# link text = $2
		  \\]
		  \\(			# literal paren
			[ \\t]*
			<?(.*?)>?	# href = $3
			[ \\t]*
			(			# $4
			  (['\""])	# quote char = $5
			  (.*?)		# Title = $6
			  \\5		# matching quote
			)?			# title is optional
		  \\)
		)
		}xs"",
		'_DoAnchors_inline_callback', $text);

	return $text;
}
function _DoAnchors_reference_callback($matches) {
	global $md_urls, $md_titles, $md_escape_table;
	$whole_match = $matches[1];
	$link_text   = $matches[2];
	$link_id     = strtolower($matches[3]);

	if ($link_id == """") {
		$link_id = strtolower($link_text); # for shortcut links like [this][].
	}

	if (isset($md_urls[$link_id])) {
		$url = $md_urls[$link_id];
		# We've got to encode these to avoid conflicting with italics/bold.
		$url = str_replace(array('*', '_'),
						   array($md_escape_table['*'], $md_escape_table['_']),
						   $url);
		$result = ""<a href=\""$url\"""";
		if ( isset( $md_titles[$link_id] ) ) {
			$title = $md_titles[$link_id];
			$title = str_replace(array('*',     '_'),
								 array($md_escape_table['*'],
									   $md_escape_table['_']), $title);
			$result .=  "" title=\""$title\"""";
		}
		$result .= "">$link_text</a>"";
	}
	else {
		$result = $whole_match;
	}
	return $result;
}
function _DoAnchors_inline_callback($matches) {
	global $md_escape_table;
	$whole_match	= $matches[1];
	$link_text		= $matches[2];
	$url			= $matches[3];
	$title			=& $matches[6];

	# We've got to encode these to avoid conflicting with italics/bold.
	$url = str_replace(array('*', '_'),
					   array($md_escape_table['*'], $md_escape_table['_']),
					   $url);
	$result = ""<a href=\""$url\"""";
	if (isset($title)) {
		$title = str_replace('""', '&quot;', $title);
		$title = str_replace(array('*', '_'),
							 array($md_escape_table['*'], $md_escape_table['_']),
							 $title);
		$result .=  "" title=\""$title\"""";
	}

	$result .= "">$link_text</a>"";

	return $result;
}


function _DoImages($text) {
#
# Turn Markdown image shortcuts into <img> tags.
#
	global $md_nested_brackets;

	#
	# First, handle reference-style labeled images: ![alt text][id]
	#
	$text = preg_replace_callback('{
		(				# wrap whole match in $1
		  !\[
			('.$md_nested_brackets.')		# alt text = $2
		  \]

		  [ ]?				# one optional space
		  (?:\n[ ]*)?		# one optional newline followed by spaces

		  \[
			(.*?)		# id = $3
		  \]

		)
		}xs',
		'_DoImages_reference_callback', $text);

	#
	# Next, handle inline images:  ![alt text](url ""optional title"")
	# Don't forget: encode * and _

	$text = preg_replace_callback('{
		(				# wrap whole match in $1
		  !\[
			('.$md_nested_brackets.')		# alt text = $2
		  \]
		  \(			# literal paren
			[ \t]*
			<?(\S+?)>?	# src url = $3
			[ \t]*
			(			# $4
			  ([\'""])	# quote char = $5
			  (.*?)		# title = $6
			  \5		# matching quote
			  [ \t]*
			)?			# title is optional
		  \)
		)
		}xs',
		'_DoImages_inline_callback', $text);

	return $text;
}
function _DoImages_reference_callback($matches) {
	global $md_urls, $md_titles, $md_empty_element_suffix, $md_escape_table;
	$whole_match = $matches[1];
	$alt_text    = $matches[2];
	$link_id     = strtolower($matches[3]);

	if ($link_id == """") {
		$link_id = strtolower($alt_text); # for shortcut links like ![this][].
	}

	$alt_text = str_replace('""', '&quot;', $alt_text);
	if (isset($md_urls[$link_id])) {
		$url = $md_urls[$link_id];
		# We've got to encode these to avoid conflicting with italics/bold.
		$url = str_replace(array('*', '_'),
						   array($md_escape_table['*'], $md_escape_table['_']),
						   $url);
		$result = ""<img src=\""$url\"" alt=\""$alt_text\"""";
		if (isset($md_titles[$link_id])) {
			$title = $md_titles[$link_id];
			$title = str_replace(array('*', '_'),
								 array($md_escape_table['*'],
									   $md_escape_table['_']), $title);
			$result .=  "" title=\""$title\"""";
		}
		$result .= $md_empty_element_suffix;
	}
	else {
		# If there's no such link ID, leave intact:
		$result = $whole_match;
	}

	return $result;
}
function _DoImages_inline_callback($matches) {
	global $md_empty_element_suffix, $md_escape_table;
	$whole_match	= $matches[1];
	$alt_text		= $matches[2];
	$url			= $matches[3];
	$title			= '';
	if (isset($matches[6])) {
		$title		= $matches[6];
	}

	$alt_text = str_replace('""', '&quot;', $alt_text);
	$title    = str_replace('""', '&quot;', $title);
	# We've got to encode these to avoid conflicting with italics/bold.
	$url = str_replace(array('*', '_'),
					   array($md_escape_table['*'], $md_escape_table['_']),
					   $url);
	$result = ""<img src=\""$url\"" alt=\""$alt_text\"""";
	if (isset($title)) {
		$title = str_replace(array('*', '_'),
							 array($md_escape_table['*'], $md_escape_table['_']),
							 $title);
		$result .=  "" title=\""$title\""""; # $title already quoted
	}
	$result .= $md_empty_element_suffix;

	return $result;
}


function _DoHeaders($text) {
	# Setext-style headers:
	#	  Header 1
	#	  ========
	#
	#	  Header 2
	#	  --------
	#
	$text = preg_replace(
		array('{ ^(.+)[ \t]*\n=+[ \t]*\n+ }emx',
			  '{ ^(.+)[ \t]*\n-+[ \t]*\n+ }emx'),
		array(""'<h1>'._RunSpanGamut(_UnslashQuotes('\\1')).'</h1>\n\n'"",
			  ""'<h2>'._RunSpanGamut(_UnslashQuotes('\\1')).'</h2>\n\n'""),
		$text);

	# atx-style headers:
	#	# Header 1
	#	## Header 2
	#	## Header 2 with closing hashes ##
	#	...
	#	###### Header 6
	#
	$text = preg_replace(""{
			^(\\#{1,6})	# $1 = string of #'s
			[ \\t]*
			(.+?)		# $2 = Header text
			[ \\t]*
			\\#*			# optional closing #'s (not counted)
			\\n+
		}xme"",
		""'<h'.strlen('\\1').'>'._RunSpanGamut(_UnslashQuotes('\\2')).'</h'.strlen('\\1').'>\n\n'"",
		$text);

	return $text;
}


function _DoLists($text) {
#
# Form HTML ordered (numbered) and unordered (bulleted) lists.
#
	global $md_tab_width, $md_list_level;
	$less_than_tab = $md_tab_width - 1;

	# Re-usable patterns to match list item bullets and number markers:
	$marker_ul  = '[*+-]';
	$marker_ol  = '\d+[.]';
	$marker_any = ""(?:$marker_ul|$marker_ol)"";

	$markers = array($marker_ul, $marker_ol);

	foreach ($markers as $marker) {
		# Re-usable pattern to match any entirel ul or ol list:
		$whole_list = '
			(								# $1 = whole list
			  (								# $2
				[ ]{0,'.$less_than_tab.'}
				('.$marker.')				# $3 = first list item marker
				[ \t]+
			  )
			  (?s:.+?)
			  (								# $4
				  \z
				|
				  \n{2,}
				  (?=\S)
				  (?!						# Negative lookahead for another list item marker
					[ \t]*
					'.$marker.'[ \t]+
				  )
			  )
			)
		'; // mx

		# We use a different prefix before nested lists than top-level lists.
		# See extended comment in _ProcessListItems().

		if ($md_list_level) {
			$text = preg_replace_callback('{
					^
					'.$whole_list.'
				}mx',
				'_DoLists_callback_top', $text);
		}
		else {
			$text = preg_replace_callback('{
					(?:(?<=\n\n)|\A\n?)
					'.$whole_list.'
				}mx',
				'_DoLists_callback_nested', $text);
		}
	}

	return $text;
}
function _DoLists_callback_top($matches) {
	# Re-usable patterns to match list item bullets and number markers:
	$marker_ul  = '[*+-]';
	$marker_ol  = '\d+[.]';
	$marker_any = ""(?:$marker_ul|$marker_ol)"";

	$list = $matches[1];
	$list_type = preg_match(""/$marker_ul/"", $matches[3]) ? ""ul"" : ""ol"";

	$marker_any = ( $list_type == ""ul"" ? $marker_ul : $marker_ol );

	# Turn double returns into triple returns, so that we can make a
	# paragraph for the last item in a list, if necessary:
	$list = preg_replace(""/\n{2,}/"", ""\n\n\n"", $list);
	$result = _ProcessListItems($list, $marker_any);

	# Trim any trailing whitespace, to put the closing `</$list_type>`
	# up on the preceding line, to get it past the current stupid
	# HTML block parser. This is a hack to work around the terrible
	# hack that is the HTML block parser.
	$result = rtrim($result);
	$result = ""<$list_type>"" . $result . ""</$list_type>\n"";
	return $result;
}
function _DoLists_callback_nested($matches) {
	# Re-usable patterns to match list item bullets and number markers:
	$marker_ul  = '[*+-]';
	$marker_ol  = '\d+[.]';
	$marker_any = ""(?:$marker_ul|$marker_ol)"";

	$list = $matches[1];
	$list_type = preg_match(""/$marker_ul/"", $matches[3]) ? ""ul"" : ""ol"";

	$marker_any = ( $list_type == ""ul"" ? $marker_ul : $marker_ol );

	# Turn double returns into triple returns, so that we can make a
	# paragraph for the last item in a list, if necessary:
	$list = preg_replace(""/\n{2,}/"", ""\n\n\n"", $list);
	$result = _ProcessListItems($list, $marker_any);
	$result = ""<$list_type>\n"" . $result . ""</$list_type>\n"";
	return $result;
}


function _ProcessListItems($list_str, $marker_any) {
#
#	Process the contents of a single ordered or unordered list, splitting it
#	into individual list items.
#
	global $md_list_level;

	# The $md_list_level global keeps track of when we're inside a list.
	# Each time we enter a list, we increment it; when we leave a list,
	# we decrement. If it's zero, we're not in a list anymore.
	#
	# We do this because when we're not inside a list, we want to treat
	# something like this:
	#
	#		I recommend upgrading to version
	#		8. Oops, now this line is treated
	#		as a sub-list.
	#
	# As a single paragraph, despite the fact that the second line starts
	# with a digit-period-space sequence.
	#
	# Whereas when we're inside a list (or sub-list), that line will be
	# treated as the start of a sub-list. What a kludge, huh? This is
	# an aspect of Markdown's syntax that's hard to parse perfectly
	# without resorting to mind-reading. Perhaps the solution is to
	# change the syntax rules such that sub-lists must start with a
	# starting cardinal number; e.g. ""1."" or ""a."".

	$md_list_level++;

	# trim trailing blank lines:
	$list_str = preg_replace(""/\n{2,}\\z/"", ""\n"", $list_str);

	$list_str = preg_replace_callback('{
		(\n)?							# leading line = $1
		(^[ \t]*)						# leading whitespace = $2
		('.$marker_any.') [ \t]+		# list marker = $3
		((?s:.+?)						# list item text   = $4
		(\n{1,2}))
		(?= \n* (\z | \2 ('.$marker_any.') [ \t]+))
		}xm',
		'_ProcessListItems_callback', $list_str);

	$md_list_level--;
	return $list_str;
}
function _ProcessListItems_callback($matches) {
	$item = $matches[4];
	$leading_line =& $matches[1];
	$leading_space =& $matches[2];

	if ($leading_line || preg_match('/\n{2,}/', $item)) {
		$item = _RunBlockGamut(_Outdent($item));
	}
	else {
		# Recursion for sub-lists:
		$item = _DoLists(_Outdent($item));
		$item = preg_replace('/\n+$/', '', $item);
		$item = _RunSpanGamut($item);
	}

	return ""<li>"" . $item . ""</li>\n"";
}


function _DoCodeBlocks($text) {
#
#	Process Markdown `<pre><code>` blocks.
#
	global $md_tab_width;
	$text = preg_replace_callback(""{
			(?:\\n\\n|\\A)
			(	            # $1 = the code block -- one or more lines, starting with a space/tab
			  (?:
				(?:[ ]\{$md_tab_width} | \\t)  # Lines must start with a tab or a tab-width of spaces
				.*\\n+
			  )+
			)
			((?=^[ ]{0,$md_tab_width}\\S)|\\Z)	# Lookahead for non-space at line-start, or end of doc
		}xm"",
		'_DoCodeBlocks_callback', $text);

	return $text;
}
function _DoCodeBlocks_callback($matches) {
	$codeblock = $matches[1];

	$codeblock = _EncodeCode(_Outdent($codeblock));
//	$codeblock = _Detab($codeblock);
	# trim leading newlines and trailing whitespace
	$codeblock = preg_replace(array('/\A\n+/', '/\s+\z/'), '', $codeblock);

	$result = ""\n\n<pre><code>"" . $codeblock . ""\n</code></pre>\n\n"";

	return $result;
}


function _DoCodeSpans($text) {
#
# 	*	Backtick quotes are used for <code></code> spans.
#
# 	*	You can use multiple backticks as the delimiters if you want to
# 		include literal backticks in the code span. So, this input:
#
#		  Just type ``foo `bar` baz`` at the prompt.
#
#	  	Will translate to:
#
#		  <p>Just type <code>foo `bar` baz</code> at the prompt.</p>
#
#		There's no arbitrary limit to the number of backticks you
#		can use as delimters. If you need three consecutive backticks
#		in your code, use four for delimiters, etc.
#
#	*	You can use spaces to get literal backticks at the edges:
#
#		  ... type `` `bar` `` ...
#
#	  	Turns to:
#
#		  ... type <code>`bar`</code> ...
#
	$text = preg_replace_callback('@
			(?<!\\\)	# Character before opening ` can\'t be a backslash
			(`+)		# $1 = Opening run of `
			(.+?)		# $2 = The code block
			(?<!`)
			\1			# Matching closer
			(?!`)
		@xs',
		'_DoCodeSpans_callback', $text);

	return $text;
}
function _DoCodeSpans_callback($matches) {
	$c = $matches[2];
	$c = preg_replace('/^[ \t]*/', '', $c); # leading whitespace
	$c = preg_replace('/[ \t]*$/', '', $c); # trailing whitespace
	$c = _EncodeCode($c);
	return ""<code>$c</code>"";
}


function _EncodeCode($_) {
#
# Encode/escape certain characters inside Markdown code runs.
# The point is that in code, these characters are literals,
# and lose their special Markdown meanings.
#
	global $md_escape_table;

	# Encode all ampersands; HTML entities are not
	# entities within a Markdown code span.
	$_ = str_replace('&', '&amp;', $_);

	# Do the angle bracket song and dance:
	$_ = str_replace(array('<',    '>'),
					 array('&lt;', '&gt;'), $_);

	# Now, escape characters that are magic in Markdown:
	$_ = str_replace(array_keys($md_escape_table),
					 array_values($md_escape_table), $_);

	return $_;
}


function _DoItalicsAndBold($text) {
	# <strong> must go first:
	$text = preg_replace('{
			(						# $1: Marker
				(?<!\*\*) \*\* |	#     (not preceded by two chars of
				(?<!__)   __		#      the same marker)
			)
			(?=\S) 					# Not followed by whitespace
			(?!\1)					#   or two others marker chars.
			(						# $2: Content
				(?:
					[^*_]+?			# Anthing not em markers.
				|
									# Balence any regular emphasis inside.
					([*_]) (?=\S) .+? (?<=\S) \3	# $3: em char (* or _)
				|
					(?! \1 ) .		# Allow unbalenced * and _.
				)+?
			)
			(?<=\S) \1				# End mark not preceded by whitespace.
		}sx',
		'<strong>\2</strong>', $text);
	# Then <em>:
	$text = preg_replace(
		'{ ( (?<!\*)\* | (?<!_)_ ) (?=\S) (?! \1) (.+?) (?<=\S) \1 }sx',
		'<em>\2</em>', $text);

	return $text;
}


function _DoBlockQuotes($text) {
	$text = preg_replace_callback('/
		  (								# Wrap whole match in $1
			(
			  ^[ \t]*>[ \t]?			# "">"" at the start of a line
				.+\n					# rest of the first line
			  (.+\n)*					# subsequent consecutive lines
			  \n*						# blanks
			)+
		  )
		/xm',
		'_DoBlockQuotes_callback', $text);

	return $text;
}
function _DoBlockQuotes_callback($matches) {
	$bq = $matches[1];
	# trim one level of quoting - trim whitespace-only lines
	$bq = preg_replace(array('/^[ \t]*>[ \t]?/m', '/^[ \t]+$/m'), '', $bq);
	$bq = _RunBlockGamut($bq);		# recurse

	$bq = preg_replace('/^/m', ""  "", $bq);
	# These leading spaces screw with <pre> content, so we need to fix that:
	$bq = preg_replace_callback('{(\s*<pre>.+?</pre>)}sx',
								'_DoBlockQuotes_callback2', $bq);

	return ""<blockquote>\n$bq\n</blockquote>\n\n"";
}
function _DoBlockQuotes_callback2($matches) {
	$pre = $matches[1];
	$pre = preg_replace('/^  /m', '', $pre);
	return $pre;
}


function _FormParagraphs($text) {
#
#	Params:
#		$text - string to process with html <p> tags
#
	global $md_html_blocks;

	# Strip leading and trailing lines:
	$text = preg_replace(array('/\A\n+/', '/\n+\z/'), '', $text);

	$grafs = preg_split('/\n{2,}/', $text, -1, PREG_SPLIT_NO_EMPTY);

	#
	# Wrap <p> tags.
	#
	foreach ($grafs as $key => $value) {
		if (!isset( $md_html_blocks[$value] )) {
			$value = _RunSpanGamut($value);
			$value = preg_replace('/^([ \t]*)/', '<p>', $value);
			$value .= ""</p>"";
			$grafs[$key] = $value;
		}
	}

	#
	# Unhashify HTML blocks
	#
	foreach ($grafs as $key => $value) {
		if (isset( $md_html_blocks[$value] )) {
			$grafs[$key] = $md_html_blocks[$value];
		}
	}

	return implode(""\n\n"", $grafs);
}


function _EncodeAmpsAndAngles($text) {
# Smart processing for ampersands and angle brackets that need to be encoded.

	# Ampersand-encoding based entirely on Nat Irons's Amputator MT plugin:
	#   http://bumppo.net/projects/amputator/
	$text = preg_replace('/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/',
						 '&amp;', $text);;

	# Encode naked <'s
	$text = preg_replace('{<(?![a-z/?\$!])}i', '&lt;', $text);

	return $text;
}


function _EncodeBackslashEscapes($text) {
#
#	Parameter:  String.
#	Returns:    The string, with after processing the following backslash
#				escape sequences.
#
	global $md_escape_table, $md_backslash_escape_table;
	# Must process escaped backslashes first.
	return str_replace(array_keys($md_backslash_escape_table),
					   array_values($md_backslash_escape_table), $text);
}


function _DoAutoLinks($text) {
	$text = preg_replace(""!<((https?|ftp):[^'\"">\\s]+)>!"",
						 '<a href=""\1"">\1</a>', $text);

	# Email addresses: <address@domain.foo>
	$text = preg_replace('{
		<
        (?:mailto:)?
		(
			[-.\w]+
			\@
			[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+
		)
		>
		}exi',
		""_EncodeEmailAddress(_UnescapeSpecialChars(_UnslashQuotes('\\1')))"",
		$text);

	return $text;
}


function _EncodeEmailAddress($addr) {
#
#	Input: an email address, e.g. ""foo@example.com""
#
#	Output: the email address as a mailto link, with each character
#		of the address encoded as either a decimal or hex entity, in
#		the hopes of foiling most address harvesting spam bots. E.g.:
#
#	  <a href=""&#x6D;&#97;&#105;&#108;&#x74;&#111;:&#102;&#111;&#111;&#64;&#101;
#		x&#x61;&#109;&#x70;&#108;&#x65;&#x2E;&#99;&#111;&#109;"">&#102;&#111;&#111;
#		&#64;&#101;x&#x61;&#109;&#x70;&#108;&#x65;&#x2E;&#99;&#111;&#109;</a>
#
#	Based by a filter by Matthew Wickline, posted to the BBEdit-Talk
#	mailing list: <http://tinyurl.com/yu7ue>
#
	$addr = ""mailto:"" . $addr;
	$length = strlen($addr);

	# leave ':' alone (to spot mailto: later)
	$addr = preg_replace_callback('/([^\:])/',
								  '_EncodeEmailAddress_callback', $addr);

	$addr = ""<a href=\""$addr\"">$addr</a>"";
	# strip the mailto: from the visible part
	$addr = preg_replace('/"">.+?:/', '"">', $addr);

	return $addr;
}
function _EncodeEmailAddress_callback($matches) {
	$char = $matches[1];
	$r = rand(0, 100);
	# roughly 10% raw, 45% hex, 45% dec
	# '@' *must* be encoded. I insist.
	if ($r > 90 && $char != '@') return $char;
	if ($r < 45) return '&#x'.dechex(ord($char)).';';
	return '&#'.ord($char).';';
}


function _UnescapeSpecialChars($text) {
#
# Swap back in all the special characters we've hidden.
#
	global $md_escape_table;
	return str_replace(array_values($md_escape_table),
					   array_keys($md_escape_table), $text);
}


# _TokenizeHTML is shared between PHP Markdown and PHP SmartyPants.
# We only define it if it is not already defined.
if (!function_exists('_TokenizeHTML')) :
function _TokenizeHTML($str) {
#
#   Parameter:  String containing HTML markup.
#   Returns:    An array of the tokens comprising the input
#               string. Each token is either a tag (possibly with nested,
#               tags contained therein, such as <a href=""<MTFoo>"">, or a
#               run of text between tags. Each element of the array is a
#               two-element array; the first is either 'tag' or 'text';
#               the second is the actual value.
#
#
#   Regular expression derived from the _tokenize() subroutine in
#   Brad Choate's MTRegex plugin.
#   <http://www.bradchoate.com/past/mtregex.php>
#
	$index = 0;
	$tokens = array();

	$match = '(?s:<!(?:--.*?--\s*)+>)|'.	# comment
			 '(?s:<\?.*?\?>)|'.				# processing instruction
			 								# regular tags
			 '(?:<[/!$]?[-a-zA-Z0-9:]+\b(?>[^""\'>]+|""[^""]*""|\'[^\']*\')*>)';

	$parts = preg_split(""{($match)}"", $str, -1, PREG_SPLIT_DELIM_CAPTURE);

	foreach ($parts as $part) {
		if (++$index % 2 && $part != '')
			$tokens[] = array('text', $part);
		else
			$tokens[] = array('tag', $part);
	}

	return $tokens;
}
endif;


function _Outdent($text) {
#
# Remove one level of line-leading tabs or spaces
#
	global $md_tab_width;
	return preg_replace(""/^(\\t|[ ]{1,$md_tab_width})/m"", """", $text);
}


function _Detab($text) {
#
# Replace tabs with the appropriate amount of space.
#
	global $md_tab_width;

	# For each line we separate the line in blocks delemited by
	# tab characters. Then we reconstruct every line by adding the
	# appropriate number of space between each blocks.

	$lines = explode(""\n"", $text);
	$text = """";

	foreach ($lines as $line) {
		# Split in blocks.
		$blocks = explode(""\t"", $line);
		# Add each blocks to the line.
		$line = $blocks[0];
		unset($blocks[0]); # Do not add first block twice.
		foreach ($blocks as $block) {
			# Calculate amount of space, insert spaces, insert block.
			$amount = $md_tab_width - strlen($line) % $md_tab_width;
			$line .= str_repeat("" "", $amount) . $block;
		}
		$text .= ""$line\n"";
	}
	return $text;
}


function _UnslashQuotes($text) {
#
#	This function is useful to remove automaticaly slashed double quotes
#	when using preg_replace and evaluating an expression.
#	Parameter:  String.
#	Returns:    The string with any slash-double-quote (\"") sequence replaced
#				by a single double quote.
#
	return str_replace('\""', '""', $text);
}


/*

PHP Markdown
============

Description
-----------

This is a PHP translation of the original Markdown formatter written in
Perl by John Gruber.

Markdown is a text-to-HTML filter; it translates an easy-to-read /
easy-to-write structured text format into HTML. Markdown's text format
is most similar to that of plain text email, and supports features such
as headers, *emphasis*, code blocks, blockquotes, and links.

Markdown's syntax is designed not as a generic markup language, but
specifically to serve as a front-end to (X)HTML. You can use span-level
HTML tags anywhere in a Markdown document, and you can use block level
HTML tags (like <div> and <table> as well).

For more information about Markdown's syntax, see:

<http://daringfireball.net/projects/markdown/>


Bugs
----

To file bug reports please send email to:

<michel.fortin@michelf.com>

Please include with your report: (1) the example input; (2) the output you
expected; (3) the output Markdown actually produced.


Version History
---------------

See the readme file for detailed release notes for this version.

1.0.1b - 6 Jun 2005

1.0.1a - 15 Apr 2005

1.0.1 - 16 Dec 2004

1.0 - 21 Aug 2004


Author & Contributors
---------------------

Original Perl version by John Gruber
<http://daringfireball.net/>

PHP port and other contributions by Michel Fortin
<http://www.michelf.com/>


Copyright and License
---------------------

Copyright (c) 2004-2005 Michel Fortin
<http://www.michelf.com/>
All rights reserved.

Copyright (c) 2003-2004 John Gruber
<http://daringfireball.net/>
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*	Redistributions of source code must retain the above copyright notice,
	this list of conditions and the following disclaimer.

*	Redistributions in binary form must reproduce the above copyright
	notice, this list of conditions and the following disclaimer in the
	documentation and/or other materials provided with the distribution.

*	Neither the name ""Markdown"" nor the names of its contributors may
	be used to endorse or promote products derived from this software
	without specific prior written permission.

This software is provided by the copyright holders and contributors ""as
is"" and any express or implied warranties, including, but not limited
to, the implied warranties of merchantability and fitness for a
particular purpose are disclaimed. In no event shall the copyright owner
or contributors be liable for any direct, indirect, incidental, special,
exemplary, or consequential damages (including, but not limited to,
procurement of substitute goods or services; loss of use, data, or
profits; or business interruption) however caused and on any theory of
liability, whether in contract, strict liability, or tort (including
negligence or otherwise) arising in any way out of the use of this
software, even if advised of the possibility of such damage.

*/"
57,1,FF,ff_addCustomCSSFile,Add custom CSS File,"Adds a custom css file to the form. To choose a css file, execute this piece and call the function ff_addCustomCSSFile('path/to/css/file') with the RELATIVE (not full!) path to your joomla installation.
Do not forget to call $this->execPieceByName('ff_InitLib') before!

Example:

global $mainframe;

$this->execPieceByName('ff_InitLib');
$this->execPieceByName('ff_addCustomCSSFile');

ff_addCustomCSSFile('templates/' . $mainframe->getTemplate() . '/css/template.css');",Before Form,"function ff_addCustomCSSFile($path){
	if(file_exists(JPATH_SITE . '/' . $path)){
		JFactory::getDocument()->addStyleSheet(JURI::root() . $path);
	}
}"
58,1,FF,ff_Constants,Constansts definitions,Library constants definitions,Before Form,"define('FF_DIE',       '_ff_die_on_errors_');
define('FF_DONTDIE',   '_ff_stay_alive_');
define('FF_IGNOREDIE', '_ff_ignore_if_dying_');

define('FF_ARRAY',     '_ff_return_as_array_');
define('FF_LIST',      '_ff_return_as_list_');
define('FF_SLIST',     '_ff_return_as_slist_');
define('FF_DLIST',     '_ff_return_as_dlist_');

define('FF_NOTRIM',    1);
define('FF_ALLOWHTML', 2);
define('FF_ALLOWRAW',  4);"
59,1,FF,ff_die,Terminate form gracefully,"Gracefully terminates the form and shows a message plus opionally a 
CONTINUE button for further redirection.

Call:

    ff_die($message=null, $action='stop', $target='', $params='', $label='Continue');
    return;

    $message = A message to display. If no message is provided, it will
               display:

                    Fatal error in $formname, processing stopped.

    $action  = 'stop' : Dont show a CONTINUE button (default)
               'self' : Redirect to the same form
               'form' : Redirect to another form 
               'page' : Redirect to another page of this site
               'home' : Redirect to homepage of the site
               'url'  : Redirect to a url

    $target  = Target name/url for 'form', 'page' and 'url'

    $params  = Additional parameters for 'self' and 'form'

    $label   = Text for the continue button

Examples:

    // Display standard message without continue button
    ff_die(); 

    // Display message without continue button
    ff_die('Sorry, cannot continue for some reason.');

    // Display standard message and return to same form with a parameter
    ff_die(null, 'self', '&ff_param_foo=bar');

    // Redirect to another form
    ff_die('Guess you are hungry now...', 'form', 'SamplePizzaShop', null, 'Order');

    // Redirect to another site page
    ff_die(
        'Something strange has happened!', 
        'page', 
        'index.php?option=com_content&task=section&id=1&Itemid=2'
    );",Untyped,"function ff_die($message='', $action='stop', $target='', $params='', $label='Continue')
{
    global $ff_processor;
    if ($ff_processor->dying) return;

    ob_end_clean();
    $form =& $ff_processor->formrow;
    if (!$message) 
        $message = 
            ""<strong>Fatal error in $form->name, form processing halted.</strong>"";
    switch ($action) {
        case 'self': $url = ff_makeSelfUrl($params); break;
        case 'form': $url = ff_makeFormUrl($target, $params); break;
        case 'page': $url = ff_makePageUrl($target); break;
        case 'home': $url = ""{mossite}""; break;
        case 'url' : $url = $target; break;
        default    : $url = '';
    } // switch
    if ($form->class1 != '') echo '<div class=""'.$form->class1.'"">'.nl();
    echo($message.'<br/><br/><br/>'.nl());
    if ($url) {
        if (!$ff_processor->inline) echo '<form action=""#redirect"">'.nl();
        if ($ff_processor->inframe) $t = 'parent'; else $t = 'document';
        echo '<input type=""button"" class=""button"" value=""'.$label.'""'.
             ' onClick=""'.$t.'.location.href=\''.htmlentities($url,ENT_QUOTES).'\';""'.
             '/>'.nl();
        if (!$ff_processor->inline) echo '</form>'.nl();
    } // if
    if ($form->class1 != '') echo '</div>'.nl();
    unset($form);
    ob_start();
    $ff_processor->suicide();
} // ff_die"
60,1,FF,ff_DisableFormTrace,Disable tracing at view time,Disables tracing for use as before form piece,Before Form,//+trace dis
61,1,FF,ff_DisableSubmitTrace,Disable tracing at submit time,Disables tracing for use as begin submit piece,Begin Submit,//+trace dis
62,1,FF,ff_dying,Query live status,Query if form is dying,Untyped,"//+trace max none
function ff_dying()
{
    global $ff_processor; 
    return $ff_processor->dying;
} // ff_dying"
63,1,FF,ff_expString,String export,Export string function: escapes special characters in c-codes,Untyped,"function ff_expString($text)
{
    return expstring($text);
} // ff_expString"
64,1,FF,ff_getPageByNameX,Get page # by element name,"Gets the page number by the name of an element. 
Typically used to redirect to a certain page in a before form piece 
as 

    $this->page = ff_getPageByName('elementname');",Untyped,"function ff_getPageByName($name)
{
    global $ff_processor;
    foreach($ff_processor->rows as $row)
        if ($row->name==$name)
            return $row->page;
    return null;
} // ff_getPageByName"
65,1,FF,ff_getParam,Get GET/POST parameter,"Direct replacement for mosGetParam. ff_getParam will attempt to filter 
out parameters that are targeted to another form on the same page.",Untyped,"function ff_getParam($name, $default=null, $mask=0)
{
    global $ff_request;
    if (substr($name,0,9)=='ff_param_') {
        if (!isset($ff_request[$name])) return $default;
        $val = $ff_request[$name];
    } else {
        if (!isset($_REQUEST[$name])) return $default;
        $val = $_REQUEST[$name];
    } // if
    $dotrim = ($mask & FF_NOTRIM)==0;
    $dostrp = ($mask & FF_ALLOWHTML)==0;
    $addsla = ($mask & FF_ALLOWRAW)==0 && !get_magic_quotes_gpc();
    $remsla = ($mask & FF_ALLOWRAW)!=0 && get_magic_quotes_gpc();
    if (is_array($val)) {
        $cnt = count($val);
        for ($v = 0; $v < $cnt; $v++)
            if (is_string($val[$v])) {
                if ($dotrim) $val[$v] = trim($val[$v]);
                if ($dostrp) $val[$v] = strip_tags($val[$v]);
                if ($addsla) $val[$v] = addslashes($val[$v]);
                if ($remsla) $val[$v] = stripslashes($val[$v]);
            } // if
    } else {
        if (is_string($val)) {
            if ($dotrim) $val = trim($val);
            if ($dostrp) $val = strip_tags($val);
            if ($addsla) $val = addslashes($val);
            if ($remsla) $val = stripslashes($val);
        } // if
    } // if
    return $val;
} // ff_getParam"
66,1,FF,ff_getSubmit,Get submited data,"Returns submitdata either as scalar, array or list. In case of list the values
are returned as a string with the values concatenated by comma.

Examples:

// Get as scalar: Optionally pass a default value as second parameter.
// If no default is provided, it will return NULL if no value was submitted

    $myval = ff_getSubmit('myvar');        // return NULL if not submitted

    $myval = ff_getSubmit('myvar',1);      // return 1 if not submitted

    $myval = ff_getSubmit('myvar','foo');  // return 'foo' if not submitted

    ff_query(
        ""insert into #__mytable(id, name) "".
        ""values ('"".
            ff_getSubmit('id')."", "".
            ff_getSubmit('name','unknown').
        ""')""
    );

// Get as array: Pass FF_ARRAY as second Parameter

    $myarr = $ff_getSubmit('myarr', FF_ARRAY);

    foreach ($myarr as $myval) ...

// Get as list: Pass either FF_LIST, FF_SLIST or FF_DLIST as 2nd parameter.

    // FF_LIST will return numeric data unquoted and strings in single quotes:
    //    1,2,'a',4

    // FF_SLIST will return all data single quoted:
    //    '1','2','a','4'

    // FF_DLIST will return all data double quoted:
    //    ""1"",""2"",""a"",""4""

    ff_query(
        ""delete from #__mytable "".
        ""where id in ("".ff_getSubmit('itemlist',FF_LIST)."")""
    );",Untyped,"function ff_getSubmit($name, $default=null)
{
    global $ff_processor;

    switch ((string)$default) {
        case FF_ARRAY: $value = array(); break;
        case FF_LIST : 
        case FF_SLIST:
        case FF_DLIST: $value = ''; break;
        default      : $value = $default;
    } // switch
    foreach ($ff_processor->submitdata as $data)
        if ($data[_FF_DATA_NAME]==$name) {
            $q = '';
            switch ((string)$default) {
                case FF_ARRAY:
                    $value[] = $data[_FF_DATA_VALUE];
                    break;
                case FF_SLIST:
                    $q = ""'"";
                case FF_DLIST:
                    if ($q=='') $q = '""';
                case FF_LIST:
                    if ($q=='' && !is_numeric($data[_FF_DATA_VALUE])) $q = ""'"";
                    if ($value!='') $value.=',';
                    $value .= $q.$data[_FF_DATA_VALUE].$q;
                    break;
                default:
                    return $data[_FF_DATA_VALUE];
            } // switch
         } // if
    return $value;
} // ff_getSubmit"
67,1,FF,ff_impString,String import,Import string function: unescapes c-coded characters of a string,Untyped,"function ff_impString($text)
{
    return impstring($text);
} // ff_impString"
68,1,FF,ff_InitLib,Init Library,"A collection of useful functions for use in form pieces. 

Include by: 

    $this->execPieceByName('ff_InitLib');",Before Form,"//+trace high none
if (!defined('FF_DIE'))                    $this->execPieceByName('ff_Constants');
if (!function_exists('ff_expstring'))      $this->execPieceByName('ff_expstring');
if (!function_exists('ff_makePageUrl'))    $this->execPieceByName('ff_makePageUrl');
if (!function_exists('ff_makeFormUrl'))    $this->execPieceByName('ff_makeFormUrl');
if (!function_exists('ff_makeSelfUrl'))    $this->execPieceByName('ff_makeSelfUrl');
if (!function_exists('ff_die'))            $this->execPieceByName('ff_die');
if (!function_exists('ff_dying'))          $this->execPieceByName('ff_dying');
if (!function_exists('ff_redirect'))       $this->execPieceByName('ff_redirect');
if (!function_exists('ff_redirectParent')) $this->execPieceByName('ff_redirectParentX');
if (!function_exists('ff_redirectPage'))   $this->execPieceByName('ff_redirectPage');
if (!function_exists('ff_redirectForm'))   $this->execPieceByName('ff_redirectForm');
if (!function_exists('ff_redirectSelf'))   $this->execPieceByName('ff_redirectSelf');
if (!function_exists('ff_setChecked'))     $this->execPieceByName('ff_setCheckedX');
if (!function_exists('ff_setSelected'))    $this->execPieceByName('ff_setSelectedX');
if (!function_exists('ff_setValue'))       $this->execPieceByName('ff_setValueX');
if (!function_exists('ff_getPageByName'))  $this->execPieceByName('ff_getPageByNameX');
if (!function_exists('ff_getParam'))       $this->execPieceByName('ff_getParam');
if (!function_exists('ff_getSubmit'))      $this->execPieceByName('ff_getSubmit');
if (!function_exists('ff_impString'))      $this->execPieceByName('ff_impString');
if (!function_exists('ff_expString'))      $this->execPieceByName('ff_expString');
if (!function_exists('ff_securityImage'))  $this->execPieceByName('ff_securityImage');
if (!function_exists('ff_select'))         $this->execPieceByName('ff_select');
if (!function_exists('ff_selectValue'))    $this->execPieceByName('ff_selectValue');
if (!function_exists('ff_query'))          $this->execPieceByName('ff_query');
if (!function_exists('ff_markdown'))       $this->execPieceByName('ff_markdown');"
69,1,FF,ff_makeFormUrl,Make URL to other form,"Redirects to another facile form. 

Call: 

    $url = ff_makeFormUrl($name, $params = '');

Example:

    $url = ff_makeFormUrl(
       'OtherForm', 
       '&ff_param_email='.urlencode($email)
    );",Untyped,"function ff_makeFormUrl($name, $params='')
{
    global $ff_processor, $ff_otherparams;
    $url = '';
    switch ($ff_processor->runmode) {
        case 2: // preview
        case 1: // backend
            $url .= 'administrator/index2.php?option=com_breezingforms&act=run'.
                    '&ff_name='.urlencode($name);
            if ($ff_processor->inframe) $url .= '&ff_frame=1';
            if ($ff_processor->border) $url .= '&ff_border=1';
            break;
        default: // frontend
            $url .= 'index.php?ff_name='.urlencode($name);
            if ($ff_otherparams['option'] == 'com_breezingforms') {
                reset($ff_otherparams);
                while (list($prop, $val) = each($ff_otherparams))
                    $url .= '&'.urlencode($prop).'='.urlencode($val);
            } else
                $url .= '&option=com_breezingforms';
            if ($ff_processor->target > 1) $url .= '&ff_target='.$ff_processor->target;
            if ($ff_processor->inframe) $url .= '&ff_frame=1';
            if ($ff_processor->border) $url .= '&ff_border=1';
            if ($ff_processor->align !=1) $url .= '&ff_align='.$ff_processor->align;
            if ($ff_processor->top>0) $url .= '&ff_top='.$ff_processor->top;
    } // switch
    return ff_makePageUrl($url. $params);
} // ff_makeFormUrl"
70,1,FF,ff_makePageUrl,Make URL to other page,"Builds an URL to another mambo page

Call: 

    $url = ff_makePageUrl($params = '');

Example:

    $url = ff_makePageUrl(
        'index.php?option=com_content&task=blogsection&id=0&Itemid=39'
    );",Untyped,"function ff_makePageUrl($params='')
{
    $url = '{mossite}';
    if ($params != '') {
        $len = strlen($url);
        if ($len > 0 && $url{$len-1} != '/') $url .= '/';
        $url .= $params;
    } // if
    return $url;
} // ff_makePageUrl"
71,1,FF,ff_makeSelfUrl,Make URL to same form,"Make an URL to the same form. 

Call: 

    $url = ff_makeSelfUrl($params = '');

Example:

    $url = ff_makeSelfUrl('&ff_param_email='.urlencode($email));",Untyped,"function ff_makeSelfUrl($params='')
{
    global $ff_processor;
    return ff_makeFormUrl($ff_processor->formrow->name, $params);
} // ff_makeSelfUrl"
72,1,FF,ff_query,Non-select queries against db,"Execute a simple db query.

Include by one of:

    $this->execPieceByName('ff_InitUtilities');
    $this->execPieceByName('ff_SubmitUtilities');
    if (!function_exists('ff_query')) $this->execPieceByName('ff_query');

Call syntax:

    [$newid = ] ff_query($sql [, $insert = 0]);

    $sql:    Sql statement to call
    $insert: 1 = return key of auto column when inserting rows
    $newid:  The key of the new row.",Untyped,"function ff_query($sql, $insert=false, $error=FF_DIE)
{
    global $ff_processor;
    $database = JFactory::getDBO();
    if ($ff_processor->dying && $error!=FF_IGNOREDIE) return -1;
    $database->setQuery($sql);
    $database->query();
    if ($database->getErrorNum()) {
        $dienow = $error==FF_DIE;
        $error = $database->stderr();
        if ($dienow) ff_die($error);
    } else {
        $error = null;
        if ($insert) return $database->insertid();
    } // if
    return 0;
} // ff_query"
73,1,FF,ff_redirect,Basic redirection,"Basic redirection routine supporting multiple targets and methods.

Call:
 
ff_redirect($url [, $target='self' , $method='post'])

    $url    = The url to redirect to including the parameters appended.

    $target = 'top', 'parent', 'self' or 'blank'

              'top'    = redirect to the top browser window
              'parent' = redirect to the parent frame
              'self'   = redirect in the same frame (the default)
              'blank'  = redirect to a new browser window 
                         (blank works with post method only)

    $method = 'post' or 'get'. The default is 'post'.

    Example:

       ff_redirect(
          'http://mysite.net/index.php?option=xxx&Itemid=33',
          'top'
       );",Untyped,"function ff_redirect($url, $target='self', $method='post')
{
    global $ff_processor, $ff_request;
    if ($ff_processor->dying) return;

    ob_end_clean();
    switch (strtolower($method)) {
        case 'get': {
            switch (strtolower($target)) {
                case 'top'   :
                case 'parent': break;
                default      : $target = 'document';
            } // switch
            echo '<script type=""text/javascript"">'.nl().
                 '<!--'.nl().
                 ""onload=function() { "".$target."".location.href='"".$url.""'; }"".nl().
                 '-->'.nl().
                 '</script>'.nl().
                 '</body>'.nl();
            break;
        } // url
        default: { // post
            $pos = strpos($url,'?');
            $ff_request = array();
            if ($pos === false)
                $action = $url;
            else {
                $action = substr($url,0,$pos);
                addRequestParams(substr($url, $pos+1));
            } // if
            switch (strtolower($target)) {
                case 'blank' : $target = ' target=""_blank""';  break;
                case 'top'   : $target = ' target=""_top""';    break;
                case 'parent': $target = ' target=""_parent""'; break;
                default      : $target = ' target=""_self""';
            } // switch
            echo '<script language=""javascript"" type=""text/javascript"">'.nl().
                 '<!--'.nl().
                 'onload = function() { document.ff_redirect.submit(); }'.nl().
                 '-->'.nl().
                 '</script>'.nl().
                 '<form action=""'.$action.'"" '.
                  'method=""post"" '.
                  'name=""ff_redirect"" id=""ff_redirect"" '.
                  'enctype=""multipart/form-data""'.
                  $target.
                 '>'.nl();
            while (list($prop, $val) = each($ff_request))
                echo '<input type=""hidden"" name=""'.$prop.'"" '.
                            'value=""'.htmlentities(urldecode($val)).'""/>'.nl();
            echo '</form>'.nl().
                 '</body>'.nl();
        } // post
    } // switch
    exit;
} // ff_redirect"
74,1,FF,ff_redirectForm,Redirect to other form,"Redirects to another facile form. 

Call: 

    ff_redirectForm($name, $params = '');

Example:

    ff_redirectForm(
        $this, 
       'SecondForm', 
       '&ff_param_email='.urlencode($email)
    );",Untyped,"function ff_redirectForm($name, $params='', $method='post')
{
    ff_redirectParent(ff_makeFormUrl($name, $params), $method);
} // ff_redirectForm"
75,1,FF,ff_redirectPage,Redirect to other page,"Redirects to another mambo page. 

Call: 

    ff_redirectPage($params = '');

Example:

    ff_redirectPage(
        'index.php?option=com_content&task=blogsection&id=0&Itemid=39'
    );",Untyped,"function ff_redirectPage($params='', $method='post')
{
    ff_redirectParent(ff_makePageUrl($params), $method);
} // ff_redirectPage"
76,1,FF,ff_redirectParentX,Redirect to parent window,"Redirects to the parent window when runing in iframe, otherwise to self. 

ff_redirectParent($url [, $method='post'])

    $url    = The url to redirect to including the parameters appended.

    $method = 'post' or 'url'. The default is 'post'.

    Example:

       ff_redirectParent(
          'http://mysite.net/index.php?option=xxx&Itemid=33',
          'url'
       );",Untyped,"function ff_redirectParent($url, $method = 'post')
{
    global $ff_processor;
    if ($ff_processor->inframe) $target = 'parent'; else $target = 'self'; 
    ff_redirect($url, $target, $method);
} // ff_redirectParent"
77,1,FF,ff_redirectSelf,Redirect to same form,"Redirects to the same form. 

Call: 

    ff_redirectSelf($params = '');

Example:

    ff_redirectSelf('&ff_param_email='.urlencode($email));",Untyped,"function ff_redirectSelf($params='', $method='post')
{
    ff_redirectParent(ff_makeSelfUrl($params), $method);
} // ff_redirectSelf"
78,1,FF,ff_securityImage,Security Image,Create code to display the security image,Untyped,"global $ff_seccode;

if (!isset($this->record_id)) { $ff_seccode = null; }

function ff_securityImage()
{
    global $ff_comsite, $ff_seccode;
    if (!isset($ff_seccode)) { 
        mt_srand((double)microtime()*1000000);
        $ff_seccode = mt_rand(10000, 99999);
        JFactory::getSession()->set('ff_seccode', $ff_seccode);
    } // if

    return '<img src=""'.JURI::root().'ff_secimage.php?option=com_breezingforms&showSecImage=true"" title="""" alt="""" />';
} // ff_securityImage"
79,1,FF,ff_select,Select rows from db,"Execute a select query

Include by one of:

    $this->execPieceByName('ff_InitUtilities');
    $this->execPieceByName('ff_SubmitUtilities');
    if (!function_exists('ff_select')) $this->execPieceByName('ff_select');

Call syntax:

    $rows = ff_select($sql);

    $sql:    Sql SELECT-statement to call
    $rows:   List of row objects",Untyped,"function ff_select($sql, $error=FF_DIE)
{
    $database = JFactory::getDBO();
    $database->setQuery($sql);
    $rows = $database->loadObjectList();
    if ($database->getErrorNum()) {
        $dienow = $error==FF_DIE;
        $error = $database->stderr();
        $rows = array();
        if ($dienow) ff_die($error);
    } else
        $error = null;
    return $rows;
} // ff_select"
80,1,FF,ff_selectValue,Select single value from db,"Execute query to read a single value

Include by one of:

    $this->execPieceByName('ff_InitUtilities');
    $this->execPieceByName('ff_SubmitUtilities');
    if (!function_exists('ff_selectValue')) $this->execPieceByName('ff_selectValue');

Call syntax:

    $value = ff_selectValue($sql);

    $sql:    Sql SELECT-statement to call
    $value:  The value returned by the database",Untyped,"function ff_selectValue($sql, $def=null, $error=FF_DIE)
{
    $database = JFactory::getDBO();
    $database->setQuery($sql);
    $value = $database->loadResult();
    if ($database->getErrorNum()) {
        $dienow = $error==FF_DIE;
        $error = $database->stderr();
        if ($dienow) ff_die($error);
    } else {
        $error = null;
        if ($value) return $value;
    } // if
    return $def;
} // ff_selectValue"
81,1,FF,ff_setCheckedX,Set checkbox/radiobutton checked,"Set a radio button or checkbox checked. 

Call: 

    ff_setChecked('name', 'value');",Untyped,"function ff_setChecked($name, $value)
{
    global $ff_processor;
    for ($r = 0; $r < $ff_processor->rowcount; $r++) {
        $row =& $ff_processor->rows[$r];
        if ($row->name==$name && $row->data1==$value)
            $row->flag1 = 1;
        unset($row);
    } // for
} // ff_setChecked"
82,1,FF,ff_setSelectedX,Set a select list option to *selected*,"Sets a select list option to selected. 

Call: 

    ff_setSelected('name', 'value');",Untyped,"function ff_setSelected($name, $value)
{
    global $ff_processor;
    for ($r = 0; $r < $ff_processor->rowcount; $r++) {
        $row =& $ff_processor->rows[$r];
        if ($row->name==$name)
            $row->data2 =
                preg_replace(
                    '/(^|\r\n|\n)(0|1);([^;]*);('.$value.')($|\r\n|\n)/',
                    '${1}1;${3};${4}${5}',
                    $row->data2
                );
        unset($row);
    } // for
} // ff_setSelected"
83,1,FF,ff_setValueX,"Set text, textarea, hidden value","Set value of a Static Text, Text, Textarea or Hidden Input. 

Call: 

    ff_setValue('name', 'value');",Untyped,"function ff_setValue($name, $value)
{
    global $ff_processor;
    for ($r = 0; $r < $ff_processor->rowcount; $r++) {
        $row =& $ff_processor->rows[$r];
        if ($row->name==$name)
            $row->data1 = $value;
        unset($row);
    } // for
} // ff_setValue"
84,1,FF,Markdown,Original Markdown Processor,"Converts text marked up by 'Markdown' into HTML.

Please use ff_markdown() in forms instead of Markdown()",Untyped,"#
# Markdown  -  A text-to-HTML conversion tool for web writers
#
# Copyright (c) 2004-2005 John Gruber
# <http://daringfireball.net/projects/markdown/>
#
# Copyright (c) 2004-2005 Michel Fortin - PHP Port
# <http://www.michelf.com/projects/php-markdown/>
#

global	$MarkdownPHPVersion, $MarkdownSyntaxVersion,
		$md_empty_element_suffix, $md_tab_width,
		$md_nested_brackets_depth, $md_nested_brackets,
		$md_escape_table, $md_backslash_escape_table,
		$md_list_level;

$MarkdownPHPVersion    = '1.0.1b'; # Mon 6 Jun 2005
$MarkdownSyntaxVersion = '1.0.1';  # Sun 12 Dec 2004


#
# Global default settings:
#
$md_empty_element_suffix = "" />"";     # Change to "">"" for HTML output
$md_tab_width = 4;

#
# WordPress settings:
#
$md_wp_posts    = true;  # Set to false to remove Markdown from posts.
$md_wp_comments = true;  # Set to false to remove Markdown from comments.


# -- WordPress Plugin Interface -----------------------------------------------
/*
Plugin Name: Markdown
Plugin URI: http://www.michelf.com/projects/php-markdown/
Description: <a href=""http://daringfireball.net/projects/markdown/syntax"">Markdown syntax</a> allows you to write using an easy-to-read, easy-to-write plain text format. Based on the original Perl version by <a href=""http://daringfireball.net/"">John Gruber</a>. <a href=""http://www.michelf.com/projects/php-markdown/"">More...</a>
Version: 1.0.1b
Author: Michel Fortin
Author URI: http://www.michelf.com/
*/
if (isset($wp_version)) {
	# More details about how it works here:
	# <http://www.michelf.com/weblog/2005/wordpress-text-flow-vs-markdown/>

	# Post content and excerpts
	if ($md_wp_posts) {
		remove_filter('the_content',  'wpautop');
		remove_filter('the_excerpt',  'wpautop');
		add_filter('the_content',     'Markdown', 6);
		add_filter('get_the_excerpt', 'Markdown', 6);
		add_filter('get_the_excerpt', 'trim', 7);
		add_filter('the_excerpt',     'md_add_p');
		add_filter('the_excerpt_rss', 'md_strip_p');

		remove_filter('content_save_pre',  'balanceTags', 50);
		remove_filter('excerpt_save_pre',  'balanceTags', 50);
		add_filter('the_content',  	  'balanceTags', 50);
		add_filter('get_the_excerpt', 'balanceTags', 9);

		function md_add_p($text) {
			if (strlen($text) == 0) return;
			if (strcasecmp(substr($text, -3), '<p>') == 0) return $text;
			return '<p>'.$text.'</p>';
		}
		function md_strip_p($t) { return preg_replace('{</?[pP]>}', '', $t); }
	}

	# Comments
	if ($md_wp_comments) {
		remove_filter('comment_text', 'wpautop');
		remove_filter('comment_text', 'make_clickable');
		add_filter('pre_comment_content', 'Markdown', 6);
		add_filter('pre_comment_content', 'md_hide_tags', 8);
		add_filter('pre_comment_content', 'md_show_tags', 12);
		add_filter('get_comment_text',    'Markdown', 6);
		add_filter('get_comment_excerpt', 'Markdown', 6);
		add_filter('get_comment_excerpt', 'md_strip_p', 7);

		global $md_hidden_tags;
		$md_hidden_tags = array(
			'<p>'	=> md5('<p>'),		'</p>'	=> md5('</p>'),
			'<pre>'	=> md5('<pre>'),	'</pre>'=> md5('</pre>'),
			'<ol>'	=> md5('<ol>'),		'</ol>'	=> md5('</ol>'),
			'<ul>'	=> md5('<ul>'),		'</ul>'	=> md5('</ul>'),
			'<li>'	=> md5('<li>'),		'</li>'	=> md5('</li>'),
			);

		function md_hide_tags($text) {
			global $md_hidden_tags;
			return str_replace(array_keys($md_hidden_tags),
								array_values($md_hidden_tags), $text);
		}
		function md_show_tags($text) {
			global $md_hidden_tags;
			return str_replace(array_values($md_hidden_tags),
								array_keys($md_hidden_tags), $text);
		}
	}
}


# -- bBlog Plugin Info --------------------------------------------------------
function identify_modifier_markdown() {
	global $MarkdownPHPVersion;
	return array(
		'name'			=> 'markdown',
		'type'			=> 'modifier',
		'nicename'		=> 'Markdown',
		'description'	=> 'A text-to-HTML conversion tool for web writers',
		'authors'		=> 'Michel Fortin and John Gruber',
		'licence'		=> 'GPL',
		'version'		=> $MarkdownPHPVersion,
		'help'			=> '<a href=""http://daringfireball.net/projects/markdown/syntax"">Markdown syntax</a> allows you to write using an easy-to-read, easy-to-write plain text format. Based on the original Perl version by <a href=""http://daringfireball.net/"">John Gruber</a>. <a href=""http://www.michelf.com/projects/php-markdown/"">More...</a>'
	);
}

# -- Smarty Modifier Interface ------------------------------------------------
function smarty_modifier_markdown($text) {
	return Markdown($text);
}

# -- Textile Compatibility Mode -----------------------------------------------
# Rename this file to ""classTextile.php"" and it can replace Textile anywhere.
if (strcasecmp(substr(__FILE__, -16), ""classTextile.php"") == 0) {
	# Try to include PHP SmartyPants. Should be in the same directory.
	@include_once 'smartypants.php';
	# Fake Textile class. It calls Markdown instead.
	class Textile {
		function TextileThis($text, $lite='', $encode='', $noimage='', $strict='') {
			if ($lite == '' && $encode == '')   $text = Markdown($text);
			if (function_exists('SmartyPants')) $text = SmartyPants($text);
			return $text;
		}
	}
}



#
# Globals:
#

# Regex to match balanced [brackets].
# Needed to insert a maximum bracked depth while converting to PHP.
$md_nested_brackets_depth = 6;
$md_nested_brackets =
	str_repeat('(?>[^\[\]]+|\[', $md_nested_brackets_depth).
	str_repeat('\])*', $md_nested_brackets_depth);

# Table of hash values for escaped characters:
$md_escape_table = array(
	""\\"" => md5(""\\""),
	""`"" => md5(""`""),
	""*"" => md5(""*""),
	""_"" => md5(""_""),
	""{"" => md5(""{""),
	""}"" => md5(""}""),
	""["" => md5(""[""),
	""]"" => md5(""]""),
	""("" => md5(""(""),
	"")"" => md5("")""),
	"">"" => md5("">""),
	""#"" => md5(""#""),
	""+"" => md5(""+""),
	""-"" => md5(""-""),
	""."" => md5("".""),
	""!"" => md5(""!"")
);
# Create an identical table but for escaped characters.
$md_backslash_escape_table;
foreach ($md_escape_table as $key => $char)
	$md_backslash_escape_table[""\\$key""] = $char;


function Markdown($text) {
#
# Main function. The order in which other subs are called here is
# essential. Link and image substitutions need to happen before
# _EscapeSpecialCharsWithinTagAttributes(), so that any *'s or _'s in the <a>
# and <img> tags get encoded.
#
	# Clear the global hashes. If we don't clear these, you get conflicts
	# from other articles when generating a page which contains more than
	# one article (e.g. an index page that shows the N most recent
	# articles):
	global $md_urls, $md_titles, $md_html_blocks;
	$md_urls = array();
	$md_titles = array();
	$md_html_blocks = array();

	# Standardize line endings:
	#   DOS to Unix and Mac to Unix
	$text = str_replace(array(""\r\n"", ""\r""), ""\n"", $text);

	# Make sure $text ends with a couple of newlines:
	$text .= ""\n\n"";

	# Convert all tabs to spaces.
	$text = _Detab($text);

	# Strip any lines consisting only of spaces and tabs.
	# This makes subsequent regexen easier to write, because we can
	# match consecutive blank lines with /\n+/ instead of something
	# contorted like /[ \t]*\n+/ .
	$text = preg_replace('/^[ \t]+$/m', '', $text);

	# Turn block-level HTML blocks into hash entries
	$text = _HashHTMLBlocks($text);

	# Strip link definitions, store in hashes.
	$text = _StripLinkDefinitions($text);

	$text = _RunBlockGamut($text);

	$text = _UnescapeSpecialChars($text);

	return $text . ""\n"";
}


function _StripLinkDefinitions($text) {
#
# Strips link definitions from text, stores the URLs and titles in
# hash references.
#
	global $md_tab_width;
	$less_than_tab = $md_tab_width - 1;

	# Link defs are in the form: ^[id]: url ""optional title""
	$text = preg_replace_callback('{
						^[ ]{0,'.$less_than_tab.'}\[(.+)\]:	# id = $1
						  [ \t]*
						  \n?				# maybe *one* newline
						  [ \t]*
						<?(\S+?)>?			# url = $2
						  [ \t]*
						  \n?				# maybe one newline
						  [ \t]*
						(?:
							(?<=\s)			# lookbehind for whitespace
							[""(]
							(.+?)			# title = $3
							["")]
							[ \t]*
						)?	# title is optional
						(?:\n+|\Z)
		}xm',
		'_StripLinkDefinitions_callback',
		$text);
	return $text;
}
function _StripLinkDefinitions_callback($matches) {
	global $md_urls, $md_titles;
	$link_id = strtolower($matches[1]);
	$md_urls[$link_id] = _EncodeAmpsAndAngles($matches[2]);
	if (isset($matches[3]))
		$md_titles[$link_id] = str_replace('""', '&quot;', $matches[3]);
	return ''; # String that will replace the block
}


function _HashHTMLBlocks($text) {
	global $md_tab_width;
	$less_than_tab = $md_tab_width - 1;

	# Hashify HTML blocks:
	# We only want to do this for block-level HTML tags, such as headers,
	# lists, and tables. That's because we still want to wrap <p>s around
	# ""paragraphs"" that are wrapped in non-block-level tags, such as anchors,
	# phrase emphasis, and spans. The list of tags we're looking for is
	# hard-coded:
	$block_tags_a = 'p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|'.
					'script|noscript|form|fieldset|iframe|math|ins|del';
	$block_tags_b = 'p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|'.
					'script|noscript|form|fieldset|iframe|math';

	# First, look for nested blocks, e.g.:
	# 	<div>
	# 		<div>
	# 		tags for inner block must be indented.
	# 		</div>
	# 	</div>
	#
	# The outermost tags must start at the left margin for this to match, and
	# the inner nested divs must be indented.
	# We need to do this before the next, more liberal match, because the next
	# match will start at the first `<div>` and stop at the first `</div>`.
	$text = preg_replace_callback(""{
				(						# save in $1
					^					# start of line  (with /m)
					<($block_tags_a)	# start tag = $2
					\\b					# word break
					(.*\\n)*?			# any number of lines, minimally matching
					</\\2>				# the matching end tag
					[ \\t]*				# trailing spaces/tabs
					(?=\\n+|\\Z)	# followed by a newline or end of document
				)
		}xm"",
		'_HashHTMLBlocks_callback',
		$text);

	#
	# Now match more liberally, simply from `\n<tag>` to `</tag>\n`
	#
	$text = preg_replace_callback(""{
				(						# save in $1
					^					# start of line  (with /m)
					<($block_tags_b)	# start tag = $2
					\\b					# word break
					(.*\\n)*?			# any number of lines, minimally matching
					.*</\\2>				# the matching end tag
					[ \\t]*				# trailing spaces/tabs
					(?=\\n+|\\Z)	# followed by a newline or end of document
				)
		}xm"",
		'_HashHTMLBlocks_callback',
		$text);

	# Special case just for <hr />. It was easier to make a special case than
	# to make the other regex more complicated.
	$text = preg_replace_callback('{
				(?:
					(?<=\n\n)		# Starting after a blank line
					|				# or
					\A\n?			# the beginning of the doc
				)
				(						# save in $1
					[ ]{0,'.$less_than_tab.'}
					<(hr)				# start tag = $2
					\b					# word break
					([^<>])*?			#
					/?>					# the matching end tag
					[ \t]*
					(?=\n{2,}|\Z)		# followed by a blank line or end of document
				)
		}x',
		'_HashHTMLBlocks_callback',
		$text);

	# Special case for standalone HTML comments:
	$text = preg_replace_callback('{
				(?:
					(?<=\n\n)		# Starting after a blank line
					|				# or
					\A\n?			# the beginning of the doc
				)
				(						# save in $1
					[ ]{0,'.$less_than_tab.'}
					(?s:
						<!
						(--.*?--\s*)+
						>
					)
					[ \t]*
					(?=\n{2,}|\Z)		# followed by a blank line or end of document
				)
			}x',
			'_HashHTMLBlocks_callback',
			$text);

	return $text;
}
function _HashHTMLBlocks_callback($matches) {
	global $md_html_blocks;
	$text = $matches[1];
	$key = md5($text);
	$md_html_blocks[$key] = $text;
	return ""\n\n$key\n\n""; # String that will replace the block
}


function _RunBlockGamut($text) {
#
# These are all the transformations that form block-level
# tags like paragraphs, headers, and list items.
#
	global $md_empty_element_suffix;

	$text = _DoHeaders($text);

	# Do Horizontal Rules:
	$text = preg_replace(
		array('{^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$}mx',
			  '{^[ ]{0,2}([ ]? -[ ]?){3,}[ \t]*$}mx',
			  '{^[ ]{0,2}([ ]? _[ ]?){3,}[ \t]*$}mx'),
		""\n<hr$md_empty_element_suffix\n"",
		$text);

	$text = _DoLists($text);
	$text = _DoCodeBlocks($text);
	$text = _DoBlockQuotes($text);

	# We already ran _HashHTMLBlocks() before, in Markdown(), but that
	# was to escape raw HTML in the original Markdown source. This time,
	# we're escaping the markup we've just created, so that we don't wrap
	# <p> tags around block-level tags.
	$text = _HashHTMLBlocks($text);
	$text = _FormParagraphs($text);

	return $text;
}


function _RunSpanGamut($text) {
#
# These are all the transformations that occur *within* block-level
# tags like paragraphs, headers, and list items.
#
	global $md_empty_element_suffix;

	$text = _DoCodeSpans($text);

	$text = _EscapeSpecialChars($text);

	# Process anchor and image tags. Images must come first,
	# because ![foo][f] looks like an anchor.
	$text = _DoImages($text);
	$text = _DoAnchors($text);

	# Make links out of things like `<http://example.com/>`
	# Must come after _DoAnchors(), because you can use < and >
	# delimiters in inline links like [this](<url>).
	$text = _DoAutoLinks($text);
	$text = _EncodeAmpsAndAngles($text);
	$text = _DoItalicsAndBold($text);

	# Do hard breaks:
	$text = preg_replace('/ {2,}\n/', ""<br$md_empty_element_suffix\n"", $text);

	return $text;
}


function _EscapeSpecialChars($text) {
	global $md_escape_table;
	$tokens = _TokenizeHTML($text);

	$text = '';   # rebuild $text from the tokens
#	$in_pre = 0;  # Keep track of when we're inside <pre> or <code> tags.
#	$tags_to_skip = ""!<(/?)(?:pre|code|kbd|script|math)[\s>]!"";

	foreach ($tokens as $cur_token) {
		if ($cur_token[0] == 'tag') {
			# Within tags, encode * and _ so they don't conflict
			# with their use in Markdown for italics and strong.
			# We're replacing each such character with its
			# corresponding MD5 checksum value; this is likely
			# overkill, but it should prevent us from colliding
			# with the escape values by accident.
			$cur_token[1] = str_replace(array('*', '_'),
				array($md_escape_table['*'], $md_escape_table['_']),
				$cur_token[1]);
			$text .= $cur_token[1];
		} else {
			$t = $cur_token[1];
			$t = _EncodeBackslashEscapes($t);
			$text .= $t;
		}
	}
	return $text;
}


function _DoAnchors($text) {
#
# Turn Markdown link shortcuts into XHTML <a> tags.
#
	global $md_nested_brackets;
	#
	# First, handle reference-style links: [link text] [id]
	#
	$text = preg_replace_callback(""{
		(					# wrap whole match in $1
		  \\[
			($md_nested_brackets)	# link text = $2
		  \\]

		  [ ]?				# one optional space
		  (?:\\n[ ]*)?		# one optional newline followed by spaces

		  \\[
			(.*?)		# id = $3
		  \\]
		)
		}xs"",
		'_DoAnchors_reference_callback', $text);

	#
	# Next, inline-style links: [link text](url ""optional title"")
	#
	$text = preg_replace_callback(""{
		(				# wrap whole match in $1
		  \\[
			($md_nested_brackets)	# link text = $2
		  \\]
		  \\(			# literal paren
			[ \\t]*
			<?(.*?)>?	# href = $3
			[ \\t]*
			(			# $4
			  (['\""])	# quote char = $5
			  (.*?)		# Title = $6
			  \\5		# matching quote
			)?			# title is optional
		  \\)
		)
		}xs"",
		'_DoAnchors_inline_callback', $text);

	return $text;
}
function _DoAnchors_reference_callback($matches) {
	global $md_urls, $md_titles, $md_escape_table;
	$whole_match = $matches[1];
	$link_text   = $matches[2];
	$link_id     = strtolower($matches[3]);

	if ($link_id == """") {
		$link_id = strtolower($link_text); # for shortcut links like [this][].
	}

	if (isset($md_urls[$link_id])) {
		$url = $md_urls[$link_id];
		# We've got to encode these to avoid conflicting with italics/bold.
		$url = str_replace(array('*', '_'),
						   array($md_escape_table['*'], $md_escape_table['_']),
						   $url);
		$result = ""<a href=\""$url\"""";
		if ( isset( $md_titles[$link_id] ) ) {
			$title = $md_titles[$link_id];
			$title = str_replace(array('*',     '_'),
								 array($md_escape_table['*'],
									   $md_escape_table['_']), $title);
			$result .=  "" title=\""$title\"""";
		}
		$result .= "">$link_text</a>"";
	}
	else {
		$result = $whole_match;
	}
	return $result;
}
function _DoAnchors_inline_callback($matches) {
	global $md_escape_table;
	$whole_match	= $matches[1];
	$link_text		= $matches[2];
	$url			= $matches[3];
	$title			=& $matches[6];

	# We've got to encode these to avoid conflicting with italics/bold.
	$url = str_replace(array('*', '_'),
					   array($md_escape_table['*'], $md_escape_table['_']),
					   $url);
	$result = ""<a href=\""$url\"""";
	if (isset($title)) {
		$title = str_replace('""', '&quot;', $title);
		$title = str_replace(array('*', '_'),
							 array($md_escape_table['*'], $md_escape_table['_']),
							 $title);
		$result .=  "" title=\""$title\"""";
	}

	$result .= "">$link_text</a>"";

	return $result;
}


function _DoImages($text) {
#
# Turn Markdown image shortcuts into <img> tags.
#
	global $md_nested_brackets;

	#
	# First, handle reference-style labeled images: ![alt text][id]
	#
	$text = preg_replace_callback('{
		(				# wrap whole match in $1
		  !\[
			('.$md_nested_brackets.')		# alt text = $2
		  \]

		  [ ]?				# one optional space
		  (?:\n[ ]*)?		# one optional newline followed by spaces

		  \[
			(.*?)		# id = $3
		  \]

		)
		}xs',
		'_DoImages_reference_callback', $text);

	#
	# Next, handle inline images:  ![alt text](url ""optional title"")
	# Don't forget: encode * and _

	$text = preg_replace_callback('{
		(				# wrap whole match in $1
		  !\[
			('.$md_nested_brackets.')		# alt text = $2
		  \]
		  \(			# literal paren
			[ \t]*
			<?(\S+?)>?	# src url = $3
			[ \t]*
			(			# $4
			  ([\'""])	# quote char = $5
			  (.*?)		# title = $6
			  \5		# matching quote
			  [ \t]*
			)?			# title is optional
		  \)
		)
		}xs',
		'_DoImages_inline_callback', $text);

	return $text;
}
function _DoImages_reference_callback($matches) {
	global $md_urls, $md_titles, $md_empty_element_suffix, $md_escape_table;
	$whole_match = $matches[1];
	$alt_text    = $matches[2];
	$link_id     = strtolower($matches[3]);

	if ($link_id == """") {
		$link_id = strtolower($alt_text); # for shortcut links like ![this][].
	}

	$alt_text = str_replace('""', '&quot;', $alt_text);
	if (isset($md_urls[$link_id])) {
		$url = $md_urls[$link_id];
		# We've got to encode these to avoid conflicting with italics/bold.
		$url = str_replace(array('*', '_'),
						   array($md_escape_table['*'], $md_escape_table['_']),
						   $url);
		$result = ""<img src=\""$url\"" alt=\""$alt_text\"""";
		if (isset($md_titles[$link_id])) {
			$title = $md_titles[$link_id];
			$title = str_replace(array('*', '_'),
								 array($md_escape_table['*'],
									   $md_escape_table['_']), $title);
			$result .=  "" title=\""$title\"""";
		}
		$result .= $md_empty_element_suffix;
	}
	else {
		# If there's no such link ID, leave intact:
		$result = $whole_match;
	}

	return $result;
}
function _DoImages_inline_callback($matches) {
	global $md_empty_element_suffix, $md_escape_table;
	$whole_match	= $matches[1];
	$alt_text		= $matches[2];
	$url			= $matches[3];
	$title			= '';
	if (isset($matches[6])) {
		$title		= $matches[6];
	}

	$alt_text = str_replace('""', '&quot;', $alt_text);
	$title    = str_replace('""', '&quot;', $title);
	# We've got to encode these to avoid conflicting with italics/bold.
	$url = str_replace(array('*', '_'),
					   array($md_escape_table['*'], $md_escape_table['_']),
					   $url);
	$result = ""<img src=\""$url\"" alt=\""$alt_text\"""";
	if (isset($title)) {
		$title = str_replace(array('*', '_'),
							 array($md_escape_table['*'], $md_escape_table['_']),
							 $title);
		$result .=  "" title=\""$title\""""; # $title already quoted
	}
	$result .= $md_empty_element_suffix;

	return $result;
}


function _DoHeaders($text) {
	# Setext-style headers:
	#	  Header 1
	#	  ========
	#
	#	  Header 2
	#	  --------
	#
	$text = preg_replace(
		array('{ ^(.+)[ \t]*\n=+[ \t]*\n+ }emx',
			  '{ ^(.+)[ \t]*\n-+[ \t]*\n+ }emx'),
		array(""'<h1>'._RunSpanGamut(_UnslashQuotes('\\1')).'</h1>\n\n'"",
			  ""'<h2>'._RunSpanGamut(_UnslashQuotes('\\1')).'</h2>\n\n'""),
		$text);

	# atx-style headers:
	#	# Header 1
	#	## Header 2
	#	## Header 2 with closing hashes ##
	#	...
	#	###### Header 6
	#
	$text = preg_replace(""{
			^(\\#{1,6})	# $1 = string of #'s
			[ \\t]*
			(.+?)		# $2 = Header text
			[ \\t]*
			\\#*			# optional closing #'s (not counted)
			\\n+
		}xme"",
		""'<h'.strlen('\\1').'>'._RunSpanGamut(_UnslashQuotes('\\2')).'</h'.strlen('\\1').'>\n\n'"",
		$text);

	return $text;
}


function _DoLists($text) {
#
# Form HTML ordered (numbered) and unordered (bulleted) lists.
#
	global $md_tab_width, $md_list_level;
	$less_than_tab = $md_tab_width - 1;

	# Re-usable patterns to match list item bullets and number markers:
	$marker_ul  = '[*+-]';
	$marker_ol  = '\d+[.]';
	$marker_any = ""(?:$marker_ul|$marker_ol)"";

	$markers = array($marker_ul, $marker_ol);

	foreach ($markers as $marker) {
		# Re-usable pattern to match any entirel ul or ol list:
		$whole_list = '
			(								# $1 = whole list
			  (								# $2
				[ ]{0,'.$less_than_tab.'}
				('.$marker.')				# $3 = first list item marker
				[ \t]+
			  )
			  (?s:.+?)
			  (								# $4
				  \z
				|
				  \n{2,}
				  (?=\S)
				  (?!						# Negative lookahead for another list item marker
					[ \t]*
					'.$marker.'[ \t]+
				  )
			  )
			)
		'; // mx

		# We use a different prefix before nested lists than top-level lists.
		# See extended comment in _ProcessListItems().

		if ($md_list_level) {
			$text = preg_replace_callback('{
					^
					'.$whole_list.'
				}mx',
				'_DoLists_callback_top', $text);
		}
		else {
			$text = preg_replace_callback('{
					(?:(?<=\n\n)|\A\n?)
					'.$whole_list.'
				}mx',
				'_DoLists_callback_nested', $text);
		}
	}

	return $text;
}
function _DoLists_callback_top($matches) {
	# Re-usable patterns to match list item bullets and number markers:
	$marker_ul  = '[*+-]';
	$marker_ol  = '\d+[.]';
	$marker_any = ""(?:$marker_ul|$marker_ol)"";

	$list = $matches[1];
	$list_type = preg_match(""/$marker_ul/"", $matches[3]) ? ""ul"" : ""ol"";

	$marker_any = ( $list_type == ""ul"" ? $marker_ul : $marker_ol );

	# Turn double returns into triple returns, so that we can make a
	# paragraph for the last item in a list, if necessary:
	$list = preg_replace(""/\n{2,}/"", ""\n\n\n"", $list);
	$result = _ProcessListItems($list, $marker_any);

	# Trim any trailing whitespace, to put the closing `</$list_type>`
	# up on the preceding line, to get it past the current stupid
	# HTML block parser. This is a hack to work around the terrible
	# hack that is the HTML block parser.
	$result = rtrim($result);
	$result = ""<$list_type>"" . $result . ""</$list_type>\n"";
	return $result;
}
function _DoLists_callback_nested($matches) {
	# Re-usable patterns to match list item bullets and number markers:
	$marker_ul  = '[*+-]';
	$marker_ol  = '\d+[.]';
	$marker_any = ""(?:$marker_ul|$marker_ol)"";

	$list = $matches[1];
	$list_type = preg_match(""/$marker_ul/"", $matches[3]) ? ""ul"" : ""ol"";

	$marker_any = ( $list_type == ""ul"" ? $marker_ul : $marker_ol );

	# Turn double returns into triple returns, so that we can make a
	# paragraph for the last item in a list, if necessary:
	$list = preg_replace(""/\n{2,}/"", ""\n\n\n"", $list);
	$result = _ProcessListItems($list, $marker_any);
	$result = ""<$list_type>\n"" . $result . ""</$list_type>\n"";
	return $result;
}


function _ProcessListItems($list_str, $marker_any) {
#
#	Process the contents of a single ordered or unordered list, splitting it
#	into individual list items.
#
	global $md_list_level;

	# The $md_list_level global keeps track of when we're inside a list.
	# Each time we enter a list, we increment it; when we leave a list,
	# we decrement. If it's zero, we're not in a list anymore.
	#
	# We do this because when we're not inside a list, we want to treat
	# something like this:
	#
	#		I recommend upgrading to version
	#		8. Oops, now this line is treated
	#		as a sub-list.
	#
	# As a single paragraph, despite the fact that the second line starts
	# with a digit-period-space sequence.
	#
	# Whereas when we're inside a list (or sub-list), that line will be
	# treated as the start of a sub-list. What a kludge, huh? This is
	# an aspect of Markdown's syntax that's hard to parse perfectly
	# without resorting to mind-reading. Perhaps the solution is to
	# change the syntax rules such that sub-lists must start with a
	# starting cardinal number; e.g. ""1."" or ""a."".

	$md_list_level++;

	# trim trailing blank lines:
	$list_str = preg_replace(""/\n{2,}\\z/"", ""\n"", $list_str);

	$list_str = preg_replace_callback('{
		(\n)?							# leading line = $1
		(^[ \t]*)						# leading whitespace = $2
		('.$marker_any.') [ \t]+		# list marker = $3
		((?s:.+?)						# list item text   = $4
		(\n{1,2}))
		(?= \n* (\z | \2 ('.$marker_any.') [ \t]+))
		}xm',
		'_ProcessListItems_callback', $list_str);

	$md_list_level--;
	return $list_str;
}
function _ProcessListItems_callback($matches) {
	$item = $matches[4];
	$leading_line =& $matches[1];
	$leading_space =& $matches[2];

	if ($leading_line || preg_match('/\n{2,}/', $item)) {
		$item = _RunBlockGamut(_Outdent($item));
	}
	else {
		# Recursion for sub-lists:
		$item = _DoLists(_Outdent($item));
		$item = preg_replace('/\n+$/', '', $item);
		$item = _RunSpanGamut($item);
	}

	return ""<li>"" . $item . ""</li>\n"";
}


function _DoCodeBlocks($text) {
#
#	Process Markdown `<pre><code>` blocks.
#
	global $md_tab_width;
	$text = preg_replace_callback(""{
			(?:\\n\\n|\\A)
			(	            # $1 = the code block -- one or more lines, starting with a space/tab
			  (?:
				(?:[ ]\{$md_tab_width} | \\t)  # Lines must start with a tab or a tab-width of spaces
				.*\\n+
			  )+
			)
			((?=^[ ]{0,$md_tab_width}\\S)|\\Z)	# Lookahead for non-space at line-start, or end of doc
		}xm"",
		'_DoCodeBlocks_callback', $text);

	return $text;
}
function _DoCodeBlocks_callback($matches) {
	$codeblock = $matches[1];

	$codeblock = _EncodeCode(_Outdent($codeblock));
//	$codeblock = _Detab($codeblock);
	# trim leading newlines and trailing whitespace
	$codeblock = preg_replace(array('/\A\n+/', '/\s+\z/'), '', $codeblock);

	$result = ""\n\n<pre><code>"" . $codeblock . ""\n</code></pre>\n\n"";

	return $result;
}


function _DoCodeSpans($text) {
#
# 	*	Backtick quotes are used for <code></code> spans.
#
# 	*	You can use multiple backticks as the delimiters if you want to
# 		include literal backticks in the code span. So, this input:
#
#		  Just type ``foo `bar` baz`` at the prompt.
#
#	  	Will translate to:
#
#		  <p>Just type <code>foo `bar` baz</code> at the prompt.</p>
#
#		There's no arbitrary limit to the number of backticks you
#		can use as delimters. If you need three consecutive backticks
#		in your code, use four for delimiters, etc.
#
#	*	You can use spaces to get literal backticks at the edges:
#
#		  ... type `` `bar` `` ...
#
#	  	Turns to:
#
#		  ... type <code>`bar`</code> ...
#
	$text = preg_replace_callback('@
			(?<!\\\)	# Character before opening ` can\'t be a backslash
			(`+)		# $1 = Opening run of `
			(.+?)		# $2 = The code block
			(?<!`)
			\1			# Matching closer
			(?!`)
		@xs',
		'_DoCodeSpans_callback', $text);

	return $text;
}
function _DoCodeSpans_callback($matches) {
	$c = $matches[2];
	$c = preg_replace('/^[ \t]*/', '', $c); # leading whitespace
	$c = preg_replace('/[ \t]*$/', '', $c); # trailing whitespace
	$c = _EncodeCode($c);
	return ""<code>$c</code>"";
}


function _EncodeCode($_) {
#
# Encode/escape certain characters inside Markdown code runs.
# The point is that in code, these characters are literals,
# and lose their special Markdown meanings.
#
	global $md_escape_table;

	# Encode all ampersands; HTML entities are not
	# entities within a Markdown code span.
	$_ = str_replace('&', '&amp;', $_);

	# Do the angle bracket song and dance:
	$_ = str_replace(array('<',    '>'),
					 array('&lt;', '&gt;'), $_);

	# Now, escape characters that are magic in Markdown:
	$_ = str_replace(array_keys($md_escape_table),
					 array_values($md_escape_table), $_);

	return $_;
}


function _DoItalicsAndBold($text) {
	# <strong> must go first:
	$text = preg_replace('{
			(						# $1: Marker
				(?<!\*\*) \*\* |	#     (not preceded by two chars of
				(?<!__)   __		#      the same marker)
			)
			(?=\S) 					# Not followed by whitespace
			(?!\1)					#   or two others marker chars.
			(						# $2: Content
				(?:
					[^*_]+?			# Anthing not em markers.
				|
									# Balence any regular emphasis inside.
					([*_]) (?=\S) .+? (?<=\S) \3	# $3: em char (* or _)
				|
					(?! \1 ) .		# Allow unbalenced * and _.
				)+?
			)
			(?<=\S) \1				# End mark not preceded by whitespace.
		}sx',
		'<strong>\2</strong>', $text);
	# Then <em>:
	$text = preg_replace(
		'{ ( (?<!\*)\* | (?<!_)_ ) (?=\S) (?! \1) (.+?) (?<=\S) \1 }sx',
		'<em>\2</em>', $text);

	return $text;
}


function _DoBlockQuotes($text) {
	$text = preg_replace_callback('/
		  (								# Wrap whole match in $1
			(
			  ^[ \t]*>[ \t]?			# "">"" at the start of a line
				.+\n					# rest of the first line
			  (.+\n)*					# subsequent consecutive lines
			  \n*						# blanks
			)+
		  )
		/xm',
		'_DoBlockQuotes_callback', $text);

	return $text;
}
function _DoBlockQuotes_callback($matches) {
	$bq = $matches[1];
	# trim one level of quoting - trim whitespace-only lines
	$bq = preg_replace(array('/^[ \t]*>[ \t]?/m', '/^[ \t]+$/m'), '', $bq);
	$bq = _RunBlockGamut($bq);		# recurse

	$bq = preg_replace('/^/m', ""  "", $bq);
	# These leading spaces screw with <pre> content, so we need to fix that:
	$bq = preg_replace_callback('{(\s*<pre>.+?</pre>)}sx',
								'_DoBlockQuotes_callback2', $bq);

	return ""<blockquote>\n$bq\n</blockquote>\n\n"";
}
function _DoBlockQuotes_callback2($matches) {
	$pre = $matches[1];
	$pre = preg_replace('/^  /m', '', $pre);
	return $pre;
}


function _FormParagraphs($text) {
#
#	Params:
#		$text - string to process with html <p> tags
#
	global $md_html_blocks;

	# Strip leading and trailing lines:
	$text = preg_replace(array('/\A\n+/', '/\n+\z/'), '', $text);

	$grafs = preg_split('/\n{2,}/', $text, -1, PREG_SPLIT_NO_EMPTY);

	#
	# Wrap <p> tags.
	#
	foreach ($grafs as $key => $value) {
		if (!isset( $md_html_blocks[$value] )) {
			$value = _RunSpanGamut($value);
			$value = preg_replace('/^([ \t]*)/', '<p>', $value);
			$value .= ""</p>"";
			$grafs[$key] = $value;
		}
	}

	#
	# Unhashify HTML blocks
	#
	foreach ($grafs as $key => $value) {
		if (isset( $md_html_blocks[$value] )) {
			$grafs[$key] = $md_html_blocks[$value];
		}
	}

	return implode(""\n\n"", $grafs);
}


function _EncodeAmpsAndAngles($text) {
# Smart processing for ampersands and angle brackets that need to be encoded.

	# Ampersand-encoding based entirely on Nat Irons's Amputator MT plugin:
	#   http://bumppo.net/projects/amputator/
	$text = preg_replace('/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/',
						 '&amp;', $text);;

	# Encode naked <'s
	$text = preg_replace('{<(?![a-z/?\$!])}i', '&lt;', $text);

	return $text;
}


function _EncodeBackslashEscapes($text) {
#
#	Parameter:  String.
#	Returns:    The string, with after processing the following backslash
#				escape sequences.
#
	global $md_escape_table, $md_backslash_escape_table;
	# Must process escaped backslashes first.
	return str_replace(array_keys($md_backslash_escape_table),
					   array_values($md_backslash_escape_table), $text);
}


function _DoAutoLinks($text) {
	$text = preg_replace(""!<((https?|ftp):[^'\"">\\s]+)>!"",
						 '<a href=""\1"">\1</a>', $text);

	# Email addresses: <address@domain.foo>
	$text = preg_replace('{
		<
        (?:mailto:)?
		(
			[-.\w]+
			\@
			[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+
		)
		>
		}exi',
		""_EncodeEmailAddress(_UnescapeSpecialChars(_UnslashQuotes('\\1')))"",
		$text);

	return $text;
}


function _EncodeEmailAddress($addr) {
#
#	Input: an email address, e.g. ""foo@example.com""
#
#	Output: the email address as a mailto link, with each character
#		of the address encoded as either a decimal or hex entity, in
#		the hopes of foiling most address harvesting spam bots. E.g.:
#
#	  <a href=""&#x6D;&#97;&#105;&#108;&#x74;&#111;:&#102;&#111;&#111;&#64;&#101;
#		x&#x61;&#109;&#x70;&#108;&#x65;&#x2E;&#99;&#111;&#109;"">&#102;&#111;&#111;
#		&#64;&#101;x&#x61;&#109;&#x70;&#108;&#x65;&#x2E;&#99;&#111;&#109;</a>
#
#	Based by a filter by Matthew Wickline, posted to the BBEdit-Talk
#	mailing list: <http://tinyurl.com/yu7ue>
#
	$addr = ""mailto:"" . $addr;
	$length = strlen($addr);

	# leave ':' alone (to spot mailto: later)
	$addr = preg_replace_callback('/([^\:])/',
								  '_EncodeEmailAddress_callback', $addr);

	$addr = ""<a href=\""$addr\"">$addr</a>"";
	# strip the mailto: from the visible part
	$addr = preg_replace('/"">.+?:/', '"">', $addr);

	return $addr;
}
function _EncodeEmailAddress_callback($matches) {
	$char = $matches[1];
	$r = rand(0, 100);
	# roughly 10% raw, 45% hex, 45% dec
	# '@' *must* be encoded. I insist.
	if ($r > 90 && $char != '@') return $char;
	if ($r < 45) return '&#x'.dechex(ord($char)).';';
	return '&#'.ord($char).';';
}


function _UnescapeSpecialChars($text) {
#
# Swap back in all the special characters we've hidden.
#
	global $md_escape_table;
	return str_replace(array_values($md_escape_table),
					   array_keys($md_escape_table), $text);
}


# _TokenizeHTML is shared between PHP Markdown and PHP SmartyPants.
# We only define it if it is not already defined.
if (!function_exists('_TokenizeHTML')) :
function _TokenizeHTML($str) {
#
#   Parameter:  String containing HTML markup.
#   Returns:    An array of the tokens comprising the input
#               string. Each token is either a tag (possibly with nested,
#               tags contained therein, such as <a href=""<MTFoo>"">, or a
#               run of text between tags. Each element of the array is a
#               two-element array; the first is either 'tag' or 'text';
#               the second is the actual value.
#
#
#   Regular expression derived from the _tokenize() subroutine in
#   Brad Choate's MTRegex plugin.
#   <http://www.bradchoate.com/past/mtregex.php>
#
	$index = 0;
	$tokens = array();

	$match = '(?s:<!(?:--.*?--\s*)+>)|'.	# comment
			 '(?s:<\?.*?\?>)|'.				# processing instruction
			 								# regular tags
			 '(?:<[/!$]?[-a-zA-Z0-9:]+\b(?>[^""\'>]+|""[^""]*""|\'[^\']*\')*>)';

	$parts = preg_split(""{($match)}"", $str, -1, PREG_SPLIT_DELIM_CAPTURE);

	foreach ($parts as $part) {
		if (++$index % 2 && $part != '')
			$tokens[] = array('text', $part);
		else
			$tokens[] = array('tag', $part);
	}

	return $tokens;
}
endif;


function _Outdent($text) {
#
# Remove one level of line-leading tabs or spaces
#
	global $md_tab_width;
	return preg_replace(""/^(\\t|[ ]{1,$md_tab_width})/m"", """", $text);
}


function _Detab($text) {
#
# Replace tabs with the appropriate amount of space.
#
	global $md_tab_width;

	# For each line we separate the line in blocks delemited by
	# tab characters. Then we reconstruct every line by adding the
	# appropriate number of space between each blocks.

	$lines = explode(""\n"", $text);
	$text = """";

	foreach ($lines as $line) {
		# Split in blocks.
		$blocks = explode(""\t"", $line);
		# Add each blocks to the line.
		$line = $blocks[0];
		unset($blocks[0]); # Do not add first block twice.
		foreach ($blocks as $block) {
			# Calculate amount of space, insert spaces, insert block.
			$amount = $md_tab_width - strlen($line) % $md_tab_width;
			$line .= str_repeat("" "", $amount) . $block;
		}
		$text .= ""$line\n"";
	}
	return $text;
}


function _UnslashQuotes($text) {
#
#	This function is useful to remove automaticaly slashed double quotes
#	when using preg_replace and evaluating an expression.
#	Parameter:  String.
#	Returns:    The string with any slash-double-quote (\"") sequence replaced
#				by a single double quote.
#
	return str_replace('\""', '""', $text);
}


/*

PHP Markdown
============

Description
-----------

This is a PHP translation of the original Markdown formatter written in
Perl by John Gruber.

Markdown is a text-to-HTML filter; it translates an easy-to-read /
easy-to-write structured text format into HTML. Markdown's text format
is most similar to that of plain text email, and supports features such
as headers, *emphasis*, code blocks, blockquotes, and links.

Markdown's syntax is designed not as a generic markup language, but
specifically to serve as a front-end to (X)HTML. You can use span-level
HTML tags anywhere in a Markdown document, and you can use block level
HTML tags (like <div> and <table> as well).

For more information about Markdown's syntax, see:

<http://daringfireball.net/projects/markdown/>


Bugs
----

To file bug reports please send email to:

<michel.fortin@michelf.com>

Please include with your report: (1) the example input; (2) the output you
expected; (3) the output Markdown actually produced.


Version History
---------------

See the readme file for detailed release notes for this version.

1.0.1b - 6 Jun 2005

1.0.1a - 15 Apr 2005

1.0.1 - 16 Dec 2004

1.0 - 21 Aug 2004


Author & Contributors
---------------------

Original Perl version by John Gruber
<http://daringfireball.net/>

PHP port and other contributions by Michel Fortin
<http://www.michelf.com/>


Copyright and License
---------------------

Copyright (c) 2004-2005 Michel Fortin
<http://www.michelf.com/>
All rights reserved.

Copyright (c) 2003-2004 John Gruber
<http://daringfireball.net/>
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*	Redistributions of source code must retain the above copyright notice,
	this list of conditions and the following disclaimer.

*	Redistributions in binary form must reproduce the above copyright
	notice, this list of conditions and the following disclaimer in the
	documentation and/or other materials provided with the distribution.

*	Neither the name ""Markdown"" nor the names of its contributors may
	be used to endorse or promote products derived from this software
	without specific prior written permission.

This software is provided by the copyright holders and contributors ""as
is"" and any express or implied warranties, including, but not limited
to, the implied warranties of merchantability and fitness for a
particular purpose are disclaimed. In no event shall the copyright owner
or contributors be liable for any direct, indirect, incidental, special,
exemplary, or consequential damages (including, but not limited to,
procurement of substitute goods or services; loss of use, data, or
profits; or business interruption) however caused and on any theory of
liability, whether in contract, strict liability, or tort (including
negligence or otherwise) arising in any way out of the use of this
software, even if advised of the possibility of such damage.

*/"
85,1,"",singolo,Singolo invio,Permette un singolo invio per utente,Before Form,"$user = JFactory::getUser();
$db = JFactory::getDbo();
$db->setQuery('SELECT COUNT(id) FROM coc2b_facileforms_records WHERE user_id =""'.$user->id.'"" AND form = 6');
$db->loadResult();
if($db->loadResult() > 0){
  // replace index.php with the url to an article explaining that the max. amount has been reached
  header(""Location: https://www.lifeintravel.it/index.php?option=com_comprofiler&view=userprofile&Itemid=331"");
  exit;
}"
